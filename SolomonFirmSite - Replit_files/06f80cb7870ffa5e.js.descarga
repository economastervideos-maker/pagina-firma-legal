;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="c8f42d5a-218f-f215-ea75-6febf38a36da")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,714260,e=>{"use strict";var t=(0,e.i(389959).createContext)(null);e.s(["default",0,t])},376847,e=>{"use strict";var t=e.i(276385),n=e.i(399528),o=e.i(921521),s=e.i(441329),r=e.i(446530),i=e.i(613355),a=e.i(140487),c=e.i(739521),l=e.i(960178),u=e.i(625484),d=e.i(283110),h=e.i(121817),g=(0,r.cssRecord)({button:[i.rcss.flex.growAndShrink(1)],closeButton:[i.rcss.position.absolute,i.rcss.top(8),i.rcss.right(8),i.rcss.p(4),i.rcss.borderRadius(4),i.rcss.cursor.pointer,i.rcss.color.foregroundDimmer,{"&:hover":{backgroundColor:"var(--color-background-higher)"}}]});e.s(["default",0,function(e){var r=e.isOpen,i=e.text,f=e.disableHomeButton,v=e.onDismiss,p=(0,n.useRouter)(),m=(0,s.isInBonsaiWebview)(p),_=(0,o.default)();return(0,t.jsx)(c.Modal,{preventClose:!0,isOpen:r,centered:!0,onRequestClose:function(){},maxWidth:600,children:(0,t.jsxs)(u.View,{gap:16,style:{position:"relative"},children:[v?(0,t.jsx)(u.View,{css:g.closeButton,onClick:v,role:"button",tabIndex:0,onKeyDown:function(e){("Enter"===e.key||" "===e.key)&&v()},children:(0,t.jsx)(d.default,{size:16})}):null,(0,t.jsxs)(u.View,{row:!0,gap:16,align:"center",children:[(0,t.jsx)(h.default,{size:24}),(0,t.jsx)(l.Header,{css:{width:"fit-content"},level:2,variant:"headerDefault",children:"Please Refresh"})]}),(0,t.jsxs)(u.View,{pr:32,gap:16,children:[(0,t.jsx)(l.Text,{children:i||"Your connection to this App has been temporarily interrupted.\n            Usually this is because of a network issue."}),m?(0,t.jsx)(l.Text,{children:"If the issue continues please logout and re-login."}):null]}),(0,t.jsxs)(u.View,{row:!0,gap:16,children:[f||m||_?null:(0,t.jsx)(a.Button,{css:g.button,text:"Back to Home",onClick:function(){p.push("/home","~/")}}),(0,t.jsx)(a.Button,{text:"Refresh",colorway:"primary",css:g.button,onClick:function(){window.location.reload()}})]})]})})}])},638472,e=>{"use strict";var t,n,o=e.i(878420),s=e.i(394212),r=e.i(297083),i=e.i(904851),a=e.i(90659),c=e.i(721281),l=e.i(167626),u=e.i(64386),d=e.i(530658),h=e.i(346715),g=e.i(817556),f=e.i(960933),v=e.i(132592),p=e.i(50452),m=e.i(164760),_=e.i(619379),y=e.i(231693),k=e.i(364520),S=e.i(468930),C=e.i(862927),E="UNCAUGHT_ERROR",b="UNEXPECTED_DISCONNECT",T="INVALID_REQUEST",M="CANCEL",w=function(e){return f.Type.Object({ok:f.Type.Literal(!1),payload:e})},x=f.Type.Object({path:f.Type.String(),message:f.Type.String()});function I(e){var t=[],n=!0,o=!1,s=void 0;try{for(var r,i=e[Symbol.iterator]();!(n=(r=i.next()).done);n=!0){var a=r.value;t.push({path:a.path,message:a.message})}}catch(e){o=!0,s=e}finally{try{n||null==i.return||i.return()}finally{if(o)throw s}}return t}f.Type.Array(x);var L=f.Type.Object({code:f.Type.Literal(M),message:f.Type.String()}),R=w(L),H=f.Type.Union([f.Type.Object({code:f.Type.Literal(E),message:f.Type.String()}),f.Type.Object({code:f.Type.Literal(b),message:f.Type.String()}),f.Type.Object({code:f.Type.Literal(T),message:f.Type.String(),extras:f.Type.Optional(f.Type.Object({firstValidationErrors:f.Type.Array(x),totalErrors:f.Type.Number()}))}),L]),B=w(H);function N(e){return"Union"===e[v.Kind]}function D(e){return JSON.parse(JSON.stringify(e))}function O(e){return"responseError"in e&&"Never"!==e.responseError[v.Kind]?D(function(e){if(!N(e))return e;var t=[];return!function e(n){if(N(n)){var o=!0,s=!1,r=void 0;try{for(var i,a=n.anyOf[Symbol.iterator]();!(o=(i=a.next()).done);o=!0){var c=i.value;e(c)}}catch(e){s=!0,r=e}finally{try{o||null==a.return||a.return()}finally{if(s)throw r}}}else t.push(n)}(e),f.Type.Union(t)}(f.Type.Union([e.responseError,H]))):D(H)}var q=function(){function e(t){(0,i._)(this,e),(0,c._)(this,"config",void 0),this.config=t}return(0,a._)(e,[{key:"procedures",value:function(e){return e}},{key:"finalize",value:function(e){return(function(){function e(t,n){(0,i._)(this,e),(0,c._)(this,"initializeState",void 0),(0,c._)(this,"procedures",void 0),this.initializeState=t.initializeState,this.procedures=n}return(0,a._)(e,[{key:"serialize",value:function(){return{procedures:Object.fromEntries(Object.entries(this.procedures).map(function(e){var t=(0,d._)(e,2),n=t[0],s=t[1];return[n,(0,o._)((0,u._)((0,o._)({init:D(s.requestInit),output:D(s.responseData),errors:O(s)},"description"in s?{description:s.description}:{}),{type:s.type}),"requestData"in s?{input:D(s.requestData)}:{})]}))}}},{key:"serializeV1Compat",value:function(){return{procedures:Object.fromEntries(Object.entries(this.procedures).map(function(e){var t=(0,d._)(e,2),n=t[0],s=t[1];return"rpc"===s.type||"subscription"===s.type?[n,(0,u._)((0,o._)({input:D(s.requestInit),output:D(s.responseData),errors:O(s)},"description"in s?{description:s.description}:{}),{type:s.type})]:[n,(0,u._)((0,o._)({init:D(s.requestInit),output:D(s.responseData),errors:O(s)},"description"in s?{description:s.description}:{}),{type:s.type,input:D(s.requestData)})]}))}}},{key:"instantiate",value:function(e){var t=this.initializeState(e);return Object.freeze((0,c._)({state:t,procedures:this.procedures},Symbol.asyncDispose,function(){return(0,r._)(function(){var e,n;return(0,g._)(this,function(o){switch(o.label){case 0:return[4,null==(e=t[Symbol.asyncDispose])?void 0:e.call(t)];case 1:return o.sent(),null==(n=t[Symbol.dispose])||n.call(t),[2]}})})()}))}}],[{key:"scaffold",value:function(e){return new q(e)}},{key:"define",value:function(t,n){var o,s;if("initializeState"in t&&"function"==typeof t.initializeState){if(!n)throw Error("Expected procedures to be defined");o=t,s=n}else o={initializeState:function(){return{}}},s=t;return new e(o,s)}}]),e})().define(this.config,e)}}]),e}(),P=f.Type.Union([f.Type.Object({ok:f.Type.Literal(!1),payload:f.Type.Object({code:f.Type.String(),message:f.Type.String(),extras:f.Type.Optional(f.Type.Unknown())})}),f.Type.Object({ok:f.Type.Literal(!0),payload:f.Type.Unknown()})]);function A(e){return{ok:!0,payload:e}}function V(e){return{ok:!1,payload:e}}var F={code:"READABLE_BROKEN",message:"Readable was broken before it is fully consumed"},j=function(){function e(){(0,i._)(this,e),(0,c._)(this,"closed",!1),(0,c._)(this,"locked",!1),(0,c._)(this,"broken",!1),(0,c._)(this,"brokenWithValuesLeftToRead",!1),(0,c._)(this,"queue",[]),(0,c._)(this,"next",null)}return(0,a._)(e,[{key:Symbol.asyncIterator,value:function(){var e=this;if(this.locked)throw TypeError("Readable is already locked");this.locked=!0;var t=!1;return{next:function(){return(0,r._)(function(){return(0,g._)(this,function(e){switch(e.label){case 0:if(t)return[2,{done:!0,value:void 0}];e.label=1;case 1:var n,o;if(0!==this.queue.length)return[3,3];if(this.closed&&!this.brokenWithValuesLeftToRead)return[2,{done:!0,value:void 0}];if(this.broken)return t=!0,[2,{done:!1,value:V(F)}];return this.next||(this.next={promise:new Promise(function(e,t){n=e,o=t}),resolve:n,reject:o}),[4,this.next.promise];case 2:return e.sent(),this.next=null,[3,1];case 3:return[2,{done:!1,value:this.queue.shift()}]}})}).call(e)},return:function(){return(0,r._)(function(){return(0,g._)(this,function(e){return this.break(),[2,{done:!0,value:void 0}]})}).call(e)}}}},{key:"collect",value:function(){return(0,r._)(function(){var e,t,n,o,r,i,a,c;return(0,g._)(this,function(l){switch(l.label){case 0:e=[],t=!1,n=!1,l.label=1;case 1:l.trys.push([1,6,7,12]),r=(0,s._)(this),l.label=2;case 2:return[4,r.next()];case 3:if(!(t=!(i=l.sent()).done))return[3,5];a=i.value,e.push(a),l.label=4;case 4:return t=!1,[3,2];case 5:return[3,12];case 6:return c=l.sent(),n=!0,o=c,[3,12];case 7:if(l.trys.push([7,,10,11]),!(t&&null!=r.return))return[3,9];return[4,r.return()];case 8:l.sent(),l.label=9;case 9:return[3,11];case 10:if(n)throw o;return[7];case 11:return[7];case 12:return[2,e]}})}).call(this)}},{key:"break",value:function(){var e;this.broken||(this.locked=!0,this.broken=!0,this.brokenWithValuesLeftToRead=this.queue.length>0,this.queue.length=0,null==(e=this.next)||e.resolve())}},{key:"isReadable",value:function(){return!this.locked&&!this.broken}},{key:"_pushValue",value:function(e){var t;if(!this.broken){if(this.closed)throw Error("Cannot push to closed Readable");this.queue.push(e),null==(t=this.next)||t.resolve()}}},{key:"_triggerClose",value:function(){var e;if(this.closed)throw Error("Unexpected closing multiple times");this.closed=!0,null==(e=this.next)||e.resolve()}},{key:"_hasValuesInQueue",value:function(){return this.queue.length>0}},{key:"isClosed",value:function(){return this.closed}}]),e}(),U=function(){function e(t){(0,i._)(this,e),(0,c._)(this,"writeCb",void 0),(0,c._)(this,"closeCb",void 0),(0,c._)(this,"closed",!1),this.writeCb=t.writeCb,this.closeCb=t.closeCb}return(0,a._)(e,[{key:"write",value:function(e){if(this.closed)throw Error("Cannot write to closed Writable");this.writeCb(e)}},{key:"isWritable",value:function(){return!this.closed}},{key:"close",value:function(e){this.closed||(void 0!==e&&this.writeCb(e),this.closed=!0,this.writeCb=function(){},this.closeCb(),this.closeCb=function(){})}},{key:"isClosed",value:function(){return this.closed}}]),e}(),G=(0,p.customAlphabet)("1234567890abcdefghijklmnopqrstuvxyzABCDEFGHIJKLMNOPQRSTUVXYZ"),W=function(){return G(12)},K=f.Type.Object({type:f.Type.Literal("ACK")}),z=f.Type.Object({type:f.Type.Literal("CLOSE")}),J="v2.0",$=["v1.1",J],Q=f.Type.Object({type:f.Type.Literal("HANDSHAKE_REQ"),protocolVersion:f.Type.String(),sessionId:f.Type.String(),expectedSessionState:f.Type.Object({nextExpectedSeq:f.Type.Integer(),nextSentSeq:f.Type.Integer()}),metadata:f.Type.Optional(f.Type.Unknown())}),Y=f.Type.Union([f.Type.Literal("SESSION_STATE_MISMATCH")]),X=f.Type.Union([f.Type.Literal("REJECTED_UNSUPPORTED_CLIENT"),f.Type.Literal("REJECTED_BY_CUSTOM_HANDLER")]),Z=f.Type.Union([X,f.Type.Literal("MALFORMED_HANDSHAKE_META"),f.Type.Literal("MALFORMED_HANDSHAKE"),f.Type.Literal("PROTOCOL_VERSION_MISMATCH")]),ee=f.Type.Union([Y,Z]),et=f.Type.Object({type:f.Type.Literal("HANDSHAKE_RESP"),status:f.Type.Union([f.Type.Object({ok:f.Type.Literal(!0),sessionId:f.Type.String()}),f.Type.Object({ok:f.Type.Literal(!1),reason:f.Type.String(),code:ee})])}),en=f.Type.Union([z,K,Q,et]),eo=(t=f.Type.Unknown(),f.Type.Object({id:f.Type.String(),from:f.Type.String(),to:f.Type.String(),seq:f.Type.Integer(),ack:f.Type.Integer(),serviceName:f.Type.Optional(f.Type.String()),procedureName:f.Type.Optional(f.Type.String()),streamId:f.Type.String(),controlFlags:f.Type.Integer(),tracing:f.Type.Optional(f.Type.Object({traceparent:f.Type.String(),tracestate:f.Type.String()})),payload:t}));function es(e){var t=e.from,n=e.to,o=e.status;return{id:W(),from:t,to:n,seq:0,ack:0,streamId:W(),controlFlags:0,payload:{type:"HANDSHAKE_RESP",status:o}}}function er(e){return{streamId:e,controlFlags:8,payload:{type:"CLOSE"}}}function ei(e,t){return{streamId:e,controlFlags:4,payload:t}}function ea(e){var t={traceparent:"",tracestate:""};return k.propagation.inject(e,t),t}function ec(e,t,n,o,s){var r=s?k.propagation.extract(y.context.active(),s):y.context.active(),i=e.startSpan("river.session",{attributes:{component:"river","river.session.id":t,"river.session.to":n,"river.session.from":o}},r),a=S.trace.setSpan(r,i);return{span:i,ctx:a}}function el(e,t,n){var o=e.startSpan("river.connection",{attributes:{component:"river","river.connection.id":t.id},links:[{context:n.span.spanContext()}]},n.ctx),s=S.trace.setSpan(n.ctx,o);return{span:o,ctx:s}}function eu(e,t){e.setStatus({code:_.SpanStatusCode.ERROR,message:t.message}),e.setAttributes({"river.error_code":t.code,"river.error_message":t.message})}var ed=function(){},eh={connectOnInvoke:!0,eagerlyConnect:!0};function eg(e,t,n,o){if("subscription"===e)return{resReadable:t};if("rpc"===e)return ef(t,o);if("upload"===e){var s=!1;return{reqWritable:n,finalize:function(){if(s)throw Error("upload stream already finalized");return s=!0,n.isClosed()||n.close(),ef(t,o)}}}return{resReadable:t,reqWritable:n}}function ef(e,t){return(0,r._)(function(){var n;return(0,g._)(this,function(o){switch(o.label){case 0:return[4,e.collect()];case 1:return(n=o.sent()).length>1&&(null==t||t.error("Expected single message from server, got multiple")),[2,n[0]]}})})()}function ev(e){return(0,l._)(e,Error)?e.message||"unknown reason":"[coerced to error] ".concat(String(e))}(0,a._)(function e(t,n,s,r){var a=this,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:200,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[];(0,i._)(this,e),(0,c._)(this,"transport",void 0),(0,c._)(this,"contextMap",void 0),(0,c._)(this,"log",void 0),(0,c._)(this,"middlewares",void 0),(0,c._)(this,"serverCancelledStreams",void 0),(0,c._)(this,"maxCancelledStreamTombstonesPerSession",void 0),(0,c._)(this,"streams",void 0),(0,c._)(this,"services",void 0),(0,c._)(this,"unregisterTransportListeners",void 0);var g={};this.middlewares=h,this.services=g,this.contextMap=new Map,r=null!=r?r:{};var f=!0,v=!1,p=void 0;try{for(var _,S=Object.entries(n)[Symbol.iterator]();!(f=(_=S.next()).done);f=!0){var C=(0,d._)(_.value,2),E=C[0],b=C[1].instantiate(r);g[E]=b,this.contextMap.set(b,(0,u._)((0,o._)({},r),{state:b.state}))}}catch(e){v=!0,p=e}finally{try{f||null==S.return||S.return()}finally{if(v)throw p}}s&&t.extendHandshake(s),this.transport=t,this.streams=new Map,this.serverCancelledStreams=new Map,this.maxCancelledStreamTombstonesPerSession=l,this.log=t.log;var T=function(e){if(e.to!==a.transport.clientId){null==(h=a.log)||h.info("got msg with destination that isn't this server, ignoring",{clientId:a.transport.clientId,transportMessage:e});return}var n,o,s,r,i,c,l,u,d,h,g=e.streamId,f=a.streams.get(g);if(f)return void f.handleMsg(e);if(null==(d=a.serverCancelledStreams.get(e.from))||!d.has(g)){var v=a.validateNewProcStream(e);v&&(n=t.tracer,o=v.initialSession,s=v.procedure.type,r=v.serviceName,i=v.procedureName,c=v.streamId,l=v.tracingCtx,u=l?k.propagation.extract(y.context.active(),l):y.context.active(),n.startActiveSpan("river.server.".concat(r,".").concat(i),{attributes:{component:"river","river.method.kind":s,"river.method.service":r,"river.method.name":i,"river.streamId":c,"span.kind":"server"},links:[{context:o.telemetry.span.spanContext()}],kind:m.SpanKind.SERVER},u,function(e){a.createNewProcStream(e,v)}))}},M=function(e){if("closing"===e.status){var t=e.session.to;null==(r=a.log)||r.info("got session disconnect from ".concat(t,", cleaning up streams"),e.session.loggingMetadata);var n=!0,o=!1,s=void 0;try{for(var r,i,c=a.streams.values()[Symbol.iterator]();!(n=(i=c.next()).done);n=!0){var l=i.value;l.from===t&&l.handleSessionDisconnect()}}catch(e){o=!0,s=e}finally{try{n||null==c.return||c.return()}finally{if(o)throw s}}a.serverCancelledStreams.delete(t)}},w=function(e){"closed"===e.status&&a.unregisterTransportListeners()};this.unregisterTransportListeners=function(){a.transport.removeEventListener("message",T),a.transport.removeEventListener("sessionStatus",M),a.transport.removeEventListener("transportStatus",w)},this.transport.addEventListener("message",T),this.transport.addEventListener("sessionStatus",M),this.transport.addEventListener("transportStatus",w)},[{key:"createNewProcStream",value:function(e,t){var n=this,s=t.streamId,i=t.initialSession,a=t.procedureName,c=t.serviceName,d=t.procedure,f=t.sessionMetadata,v=t.serviceContext,p=t.initPayload,m=t.procClosesWithInit,_=t.passInitAsDataForBackwardsCompat,y=i.to,k=i.loggingMetadata,S=i.protocolVersion,w=i.id;k.telemetry={traceId:e.spanContext().traceId,spanId:e.spanContext().spanId};var x=!0,L=new AbortController,H=this.transport.getSessionBoundSendFn(y,w),B=function(e,t){n.cancelStream(y,H,e,t)},N=function(t){if(eu(e,t),!(q.isClosed()&&F.isClosed())){x=!1;var n=V(t);q.isClosed()||(q._pushValue(n),P()),F.close(),B(s,n)}},D=function(){L.abort(),n.streams.delete(s)},O="rpc"===d.type||"upload"===d.type,q=new j,P=function(){q._triggerClose(),"v1.1"!==S||O||F.isClosed()||F.close(),F.isClosed()&&D()};_&&q._pushValue(A(p));var F=new U({writeCb:function(t){t.ok||eu(e,t.payload),H({streamId:s,controlFlags:O?e_(S):0,payload:t}),O&&F.close()},closeCb:function(){if(!O&&x){var e=er(s);e.controlFlags=e_(S),H(e)}"v1.1"!==S||q.isClosed()||P(),q.isClosed()&&D()}}),G=function(e,t){var s,r=ev(e);t.recordException((0,l._)(e,Error)?e:Error(r)),null==(s=n.log)||s.error("".concat(c,".").concat(a," handler threw an uncaught error"),(0,u._)((0,o._)({},k),{transportMessage:{procedureName:a,serviceName:c},extras:{error:r,originalException:e},tags:["uncaught-handler-error"]})),N({code:E,message:r})};m&&P();var W=(0,u._)((0,o._)({},v),{from:y,sessionId:w,metadata:f,span:e,cancel:function(e){var t={code:M,message:null!=e?e:"cancelled by server procedure handler"};return N(t),V(t)},signal:L.signal}),K=(0,u._)((0,o._)({},v),{sessionId:w,from:y,metadata:f,span:e,signal:L.signal,streamId:s,procedureName:a,serviceName:c});this.middlewares.reduceRight(function(e,t){return function(){t({ctx:K,reqInit:p,next:e})}},function(){(0,r._)(function(){var t,n;return(0,g._)(this,function(o){switch(o.label){case 0:switch(d.type){case"rpc":return[3,1];case"stream":return[3,6];case"subscription":return[3,11];case"upload":return[3,16]}return[3,21];case 1:return o.trys.push([1,3,4,5]),[4,d.handler({ctx:W,reqInit:p})];case 2:if(t=o.sent(),F.isClosed())return[2];return F.write(t),[3,5];case 3:return G(o.sent(),e),[3,5];case 4:case 9:case 14:case 19:return e.end(),[7];case 5:case 10:case 15:case 20:return[3,21];case 6:return o.trys.push([6,8,9,10]),[4,d.handler({ctx:W,reqInit:p,reqReadable:q,resWritable:F})];case 7:return o.sent(),[3,10];case 8:return G(o.sent(),e),[3,10];case 11:return o.trys.push([11,13,14,15]),[4,d.handler({ctx:W,reqInit:p,resWritable:F})];case 12:return o.sent(),[3,15];case 13:return G(o.sent(),e),[3,15];case 16:return o.trys.push([16,18,19,20]),[4,d.handler({ctx:W,reqInit:p,reqReadable:q})];case 17:if(n=o.sent(),F.isClosed())return[2];return F.write(n),[3,20];case 18:return G(o.sent(),e),[3,20];case 21:return[2]}})})()})(),L.signal.aborted||this.streams.set(s,{from:y,streamId:s,procedureName:a,serviceName:c,sessionMetadata:f,procedure:d,handleMsg:function(e){var t,s,r,i,a,c,l,g;if(e.from!==y){null==(s=n.log)||s.error("got stream message from unexpected client",(0,u._)((0,o._)({},k),{transportMessage:e,tags:["invariant-violation"]}));return}if(g=e.controlFlags,"v1.1"!==S&&(4&g)==4){C.Value.Check(R,e.payload)?r=e.payload:(r=V({code:M,message:"stream cancelled, client sent invalid payload"}),null==(i=n.log)||i.warn("got stream cancel without a valid protocol error",(0,u._)((0,o._)({},k),{transportMessage:e,validationErrors:(0,h._)(C.Value.Errors(R,e.payload)),tags:["invalid-request"]}))),q.isClosed()||(q._pushValue(r),P()),F.close();return}if(q.isClosed()){null==(a=n.log)||a.warn("received message after request stream is closed",(0,u._)((0,o._)({},k),{transportMessage:e,tags:["invalid-request"]})),N({code:T,message:"received message after request stream is closed"});return}if("requestData"in d&&C.Value.Check(d.requestData,e.payload)){q._pushValue(A(e.payload)),em(e.controlFlags,S)&&P();return}C.Value.Check(en,e.payload)&&em(e.controlFlags,S)?P():("requestData"in d?(l="message in requestData position did not match schema",c=I(C.Value.Errors(d.requestData,e.payload))):(c=I(C.Value.Errors(en,e.payload)),l="message in control payload position did not match schema"),null==(t=n.log)||t.warn(l,(0,u._)((0,o._)({},k),{transportMessage:e,validationErrors:c.map(function(e){return{path:e.path,message:e.message}}),tags:["invalid-request"]})),N({code:T,message:l,extras:{totalErrors:c.length,firstValidationErrors:c.slice(0,5)}}))},handleSessionDisconnect:function(){x=!1,q.isClosed()||(q._pushValue(V({code:b,message:"client unexpectedly disconnected"})),P()),F.close()}})}},{key:"getContext",value:function(e,t){var n=this.contextMap.get(e);if(!n){var o,s="no context found for ".concat(t);throw null==(o=this.log)||o.error(s,{clientId:this.transport.clientId,tags:["invariant-violation"]}),Error(s)}return n}},{key:"validateNewProcStream",value:function(e){var t=this,n=this.transport.sessions.get(e.from);if(!n)return null==(a=this.log)||a.error("couldn't find session for ".concat(e.from),{clientId:this.transport.clientId,transportMessage:e,tags:["invariant-violation"]}),null;var s=this.transport.getSessionBoundSendFn(e.from,n.id),r=function(n,o){t.cancelStream(e.from,s,n,o)},i=this.transport.sessionHandshakeMetadata.get(n.to);if(!i){var a,c,l="session doesn't have handshake metadata";return null==(c=this.log)||c.error(l,(0,u._)((0,o._)({},n.loggingMetadata),{tags:["invariant-violation"]})),r(e.streamId,V({code:E,message:l})),null}if((2&e.controlFlags)!=2){var d,h="can't create a new procedure stream from a message that doesn't have the stream open bit set";return null==(d=this.log)||d.warn(h,(0,u._)((0,o._)({},n.loggingMetadata),{clientId:this.transport.clientId,transportMessage:e,tags:["invalid-request"]})),r(e.streamId,V({code:T,message:h})),null}if(!e.serviceName){var g,f="missing service name in stream open message";return null==(g=this.log)||g.warn(f,(0,u._)((0,o._)({},n.loggingMetadata),{transportMessage:e,tags:["invalid-request"]})),r(e.streamId,V({code:T,message:f})),null}if(!e.procedureName){var v,p="missing procedure name in stream open message";return null==(v=this.log)||v.warn(p,(0,u._)((0,o._)({},n.loggingMetadata),{transportMessage:e,tags:["invalid-request"]})),r(e.streamId,V({code:T,message:p})),null}if(!(e.serviceName in this.services)){var m,_="couldn't find service ".concat(e.serviceName);return null==(m=this.log)||m.warn(_,(0,u._)((0,o._)({},n.loggingMetadata),{clientId:this.transport.clientId,transportMessage:e,tags:["invalid-request"]})),r(e.streamId,V({code:T,message:_})),null}var y=this.services[e.serviceName];if(!(e.procedureName in y.procedures)){var k,S="couldn't find a matching procedure for ".concat(e.serviceName,".").concat(e.procedureName);return null==(k=this.log)||k.warn(S,(0,u._)((0,o._)({},n.loggingMetadata),{transportMessage:e,tags:["invalid-request"]})),r(e.streamId,V({code:T,message:S})),null}var b=this.getContext(y,e.serviceName),M=y.procedures[e.procedureName];if(!["rpc","upload","stream","subscription"].includes(M.type))return null==(x=this.log)||x.error("got request for invalid procedure type ".concat(M.type," at ").concat(e.serviceName,".").concat(e.procedureName),(0,u._)((0,o._)({},n.loggingMetadata),{transportMessage:e,tags:["invariant-violation"]})),null;var w=!1;if("v1.1"===n.protocolVersion&&("upload"===M.type||"stream"===M.type)&&C.Value.Check(M.requestData,e.payload)&&C.Value.Check(M.requestInit,{}))w=!0;else if(!C.Value.Check(M.requestInit,e.payload)){var x,I,L="procedure init failed validation";return null==(I=this.log)||I.warn(L,(0,u._)((0,o._)({},n.loggingMetadata),{clientId:this.transport.clientId,transportMessage:e,tags:["invalid-request"]})),r(e.streamId,V({code:T,message:L})),null}return{initialSession:n,streamId:e.streamId,procedureName:e.procedureName,serviceName:e.serviceName,tracingCtx:e.tracing,initPayload:e.payload,sessionMetadata:i,procedure:M,serviceContext:b,procClosesWithInit:em(e.controlFlags,n.protocolVersion),passInitAsDataForBackwardsCompat:w}}},{key:"cancelStream",value:function(e,t,n,o){var s=this.serverCancelledStreams.get(e);s||(s=new ep(this.maxCancelledStreamTombstonesPerSession),this.serverCancelledStreams.set(e,s)),s.add(n),t(ei(n,o))}},{key:"close",value:function(){return(0,r._)(function(){var e,t,n,o,s,r,i;return(0,g._)(this,function(a){switch(a.label){case 0:this.unregisterTransportListeners(),e=!0,t=!1,n=void 0,a.label=1;case 1:a.trys.push([1,6,7,8]),o=Object.keys(this.services)[Symbol.iterator](),a.label=2;case 2:if(e=(s=o.next()).done)return[3,5];return r=s.value,[4,this.services[r][Symbol.asyncDispose]()];case 3:a.sent(),a.label=4;case 4:return e=!0,[3,2];case 5:return[3,8];case 6:return i=a.sent(),t=!0,n=i,[3,8];case 7:try{e||null==o.return||o.return()}finally{if(t)throw n}return[7];case 8:return[2]}})}).call(this)}}]);var ep=function(){function e(t){(0,i._)(this,e),(0,c._)(this,"items",void 0),(0,c._)(this,"maxItems",void 0),this.items=new Set,this.maxItems=t}return(0,a._)(e,[{key:"add",value:function(e){if(this.items.has(e))this.items.delete(e);else if(this.items.size>=this.maxItems){var t=this.items.values().next();t.done||this.items.delete(t.value)}this.items.add(e)}},{key:"has",value:function(e){return this.items.has(e)}}]),e}();function em(e,t){return"v1.1"===t?(4&e)==4:(8&e)==8}function e_(e){return"v1.1"===e?4:8}var ey="0.210.1",ek=e.i(399119),eS=e.i(663355),eC=e.i(862470),eE=e.i(445789),eb=e.i(119468),eT=e.i(463348),eM=e.i(886513),ew={debug:-1,info:0,warn:1,error:2},ex=function(e){return function(t,n){if(n&&!n.telemetry){var o=S.trace.getSpan(y.context.active());o&&(n.telemetry={traceId:o.spanContext().traceId,spanId:o.spanContext().spanId})}if(!(null==n?void 0:n.transportMessage))return void e(t,n);var s=n.transportMessage;s.payload,n.transportMessage=(0,eM._)(s,["payload"]),e(t,n)}},eI=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";(0,i._)(this,e),(0,c._)(this,"minLevel",void 0),(0,c._)(this,"output",void 0),this.minLevel=n,this.output=t}return(0,a._)(e,[{key:"debug",value:function(e,t){ew[this.minLevel]<=ew.debug&&this.output(e,null!=t?t:{},"debug")}},{key:"info",value:function(e,t){ew[this.minLevel]<=ew.info&&this.output(e,null!=t?t:{},"info")}},{key:"warn",value:function(e,t){ew[this.minLevel]<=ew.warn&&this.output(e,null!=t?t:{},"warn")}},{key:"error",value:function(e,t){ew[this.minLevel]<=ew.error&&this.output(e,null!=t?t:{},"error")}}]),e}(),eL=function(e){return{debug:ex(e.debug.bind(e)),info:ex(e.info.bind(e)),warn:ex(e.warn.bind(e)),error:ex(e.error.bind(e))}},eR=e.i(944661),eH=e.i(259535),eB=e.i(726753),eN=e.i(770663),eD={RetriesExceeded:"conn_retry_exceeded",HandshakeFailed:"handshake_failed",MessageOrderingViolated:"message_ordering_violated",InvalidMessage:"invalid_message",MessageSendFailure:"message_send_failure"},eO=function(){function e(){(0,i._)(this,e),(0,c._)(this,"eventListeners",{})}return(0,a._)(e,[{key:"removeAllListeners",value:function(){this.eventListeners={}}},{key:"numberOfListeners",value:function(e){var t,n;return null!=(n=null==(t=this.eventListeners[e])?void 0:t.size)?n:0}},{key:"addEventListener",value:function(e,t){var n;this.eventListeners[e]||(this.eventListeners[e]=new Set),null==(n=this.eventListeners[e])||n.add(t)}},{key:"removeEventListener",value:function(e,t){var n;this.eventListeners[e]&&(null==(n=this.eventListeners[e])||n.delete(t))}},{key:"dispatchEvent",value:function(e,t){var n=this.eventListeners[e];if(n){var o=(0,h._)(n),s=!0,r=!1,i=void 0;try{for(var a,c=o[Symbol.iterator]();!(s=(a=c.next()).done);s=!0)(0,a.value)(t)}catch(e){r=!0,i=e}finally{try{s||null==c.return||c.return()}finally{if(r)throw i}}}}}]),e}(),eq=new TextEncoder,eP=new TextDecoder,eA={heartbeatIntervalMs:1e3,heartbeatsUntilDead:2,sessionDisconnectGraceMs:5e3,connectionTimeoutMs:2e3,handshakeTimeoutMs:1e3,enableTransparentSessionReconnects:!0,codec:{toBuffer:function(e){return eq.encode(JSON.stringify(e,function(e){var t,n=this[e];return(0,l._)(n,Uint8Array)?{$t:(t="",n.forEach(function(e){t+=String.fromCharCode(e)}),btoa(t))}:(void 0===n?"undefined":(0,eb._)(n))==="bigint"?{$b:n.toString()}:n}))},fromBuffer:function(e){var t=JSON.parse(eP.decode(e),function(e,t){return(null==t?void 0:t.$t)!==void 0?function(e){for(var t=atob(e),n=new Uint8Array(t.length),o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return n}(t.$t):(null==t?void 0:t.$b)!==void 0?BigInt(t.$b):t});if((void 0===t?"undefined":(0,eb._)(t))!=="object"||null===t)throw Error("unpacked msg is not an object");return t}}},eV=(0,o._)({},eA,{baseIntervalMs:150,maxJitterMs:200,maxBackoffMs:32e3,attemptBudgetCapacity:5,budgetRestoreIntervalMs:200,isFatalConnectionError:function(){return!1}}),eF=(0,o._)({},eA),ej=((n=ej||{}).NoConnection="NoConnection",n.BackingOff="BackingOff",n.Connecting="Connecting",n.Handshaking="Handshaking",n.Connected="Connected",n.WaitingForHandshake="WaitingForHandshake",n),eU="session state has been consumed and is no longer valid",eG=function(e){function t(e){var n,o=e.from,s=e.options,r=e.log,a=e.tracer,l=e.codec;return(0,i._)(this,t),n=(0,ek._)(this,t),(0,c._)(n,"from",void 0),(0,c._)(n,"options",void 0),(0,c._)(n,"codec",void 0),(0,c._)(n,"tracer",void 0),(0,c._)(n,"log",void 0),n.from=o,n.options=s,n.log=r,n.tracer=a,n.codec=l,n}return(0,eE._)(t,e),t}(function(){function e(){return(0,i._)(this,e),(0,c._)(this,"_isConsumed",void 0),this._isConsumed=!1,new Proxy(this,{get:function(e,t){if("_isConsumed"===t||"id"===t||"state"===t)return Reflect.get(e,t);if("_handleStateExit"===t)return function(){e._isConsumed=!0,e._handleStateExit()};if("_handleClose"===t)return function(){e._isConsumed=!0,e._handleStateExit(),e._handleClose()};if(e._isConsumed)throw Error("".concat(eU,": getting ").concat(t.toString()," on consumed state"));return Reflect.get(e,t)},set:function(e,t,n){if(e._isConsumed)throw Error("".concat(eU,": setting ").concat(t.toString()," on consumed state"));return Reflect.set(e,t,n)}})}return(0,a._)(e,[{key:"close",value:function(){this._handleClose()}}]),e}()),eW=function(e){function t(e){(0,i._)(this,t);var n,o=e.id,s=e.to,r=e.seq,a=e.ack,l=e.sendBuffer,u=e.telemetry,d=e.log,h=e.protocolVersion,g=e.seqSent;return n=(0,ek._)(this,t,[e]),(0,c._)(n,"id",void 0),(0,c._)(n,"telemetry",void 0),(0,c._)(n,"to",void 0),(0,c._)(n,"protocolVersion",void 0),(0,c._)(n,"seq",void 0),(0,c._)(n,"seqSent",void 0),(0,c._)(n,"ack",void 0),(0,c._)(n,"sendBuffer",void 0),n.id=o,n.to=s,n.seq=r,n.ack=a,n.sendBuffer=l,n.telemetry=u,n.log=d,n.protocolVersion=h,n.seqSent=g,n}return(0,eE._)(t,e),(0,a._)(t,[{key:"loggingMetadata",get:function(){var e={clientId:this.from,connectedTo:this.to,sessionId:this.id};if(this.telemetry.span.isRecording()){var t=this.telemetry.span.spanContext();e.telemetry={traceId:t.traceId,spanId:t.spanId}}return e}},{key:"constructMsg",value:function(e){var t=(0,u._)((0,o._)({},e),{id:W(),to:this.to,from:this.from,seq:this.seq,ack:this.ack});return this.seq++,t}},{key:"nextSeq",value:function(){return this.sendBuffer.length>0?this.sendBuffer[0].seq:this.seq}},{key:"send",value:function(e){var t=this.constructMsg(e);return this.sendBuffer.push(t),{ok:!0,value:t.id}}},{key:"_handleStateExit",value:function(){}},{key:"_handleClose",value:function(){this.sendBuffer.length=0,this.telemetry.span.end()}}]),t}(eG),eK=function(e){function t(e){var n;return(0,i._)(this,t),n=(0,ek._)(this,t,[e]),(0,c._)(n,"graceExpiryTime",void 0),(0,c._)(n,"gracePeriodTimeout",void 0),(0,c._)(n,"listeners",void 0),n.listeners=e.listeners,n.graceExpiryTime=e.graceExpiryTime,n.gracePeriodTimeout=setTimeout(function(){n.listeners.onSessionGracePeriodElapsed()},n.graceExpiryTime-Date.now()),n}return(0,eE._)(t,e),(0,a._)(t,[{key:"_handleStateExit",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleStateExit",this).call(this),this.gracePeriodTimeout&&(clearTimeout(this.gracePeriodTimeout),this.gracePeriodTimeout=void 0)}},{key:"_handleClose",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleClose",this).call(this)}}]),t}(eW);function ez(e,t,n){var o=t.toBuffer(n);return o.ok?e.send(o.value)?{ok:!0,value:n.id}:{ok:!1,reason:"failed to send message"}:o}var eJ=function(e){function t(e){var n;return(0,i._)(this,t),n=(0,ek._)(this,t,[e]),(0,c._)(n,"state","Connecting"),(0,c._)(n,"connPromise",void 0),(0,c._)(n,"listeners",void 0),(0,c._)(n,"connectionTimeout",void 0),n.connPromise=e.connPromise,n.listeners=e.listeners,n.connPromise.then(function(e){n._isConsumed||n.listeners.onConnectionEstablished(e)},function(e){n._isConsumed||n.listeners.onConnectionFailed(e)}),n.connectionTimeout=setTimeout(function(){n.listeners.onConnectionTimeout()},n.options.connectionTimeoutMs),n}return(0,eE._)(t,e),(0,a._)(t,[{key:"bestEffortClose",value:function(){var e=this.log,t=this.loggingMetadata;this.connPromise.then(function(n){n.close(),null==e||e.info("connection eventually resolved but session has transitioned, closed connection",(0,o._)({},t,n.loggingMetadata))}).catch(function(){})}},{key:"_handleStateExit",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleStateExit",this).call(this),this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=void 0)}},{key:"_handleClose",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleClose",this).call(this),this.bestEffortClose()}}]),t}(eK),e$=function(e){function t(){var e;return(0,i._)(this,t),e=(0,ek._)(this,t,arguments),(0,c._)(e,"state","NoConnection"),e}return(0,eE._)(t,e),(0,a._)(t,[{key:"_handleClose",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleClose",this).call(this)}},{key:"_handleStateExit",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleStateExit",this).call(this)}}]),t}(eK),eQ=function(e){function t(e){var n;return(0,i._)(this,t),n=(0,ek._)(this,t,[e]),(0,c._)(n,"state","WaitingForHandshake"),(0,c._)(n,"conn",void 0),(0,c._)(n,"listeners",void 0),(0,c._)(n,"handshakeTimeout",void 0),(0,c._)(n,"onHandshakeData",function(e){var t=n.codec.fromBuffer(e);t.ok?n.listeners.onHandshake(t.value):n.listeners.onInvalidHandshake("could not parse handshake message: ".concat(t.reason),"MALFORMED_HANDSHAKE")}),n.conn=e.conn,n.listeners=e.listeners,n.handshakeTimeout=setTimeout(function(){n.listeners.onHandshakeTimeout()},n.options.handshakeTimeoutMs),n.conn.setDataListener(n.onHandshakeData),n.conn.setErrorListener(n.listeners.onConnectionErrored),n.conn.setCloseListener(n.listeners.onConnectionClosed),n}return(0,eE._)(t,e),(0,a._)(t,[{key:"loggingMetadata",get:function(){return(0,o._)({clientId:this.from,connId:this.conn.id},this.conn.loggingMetadata)}},{key:"sendHandshake",value:function(e){return ez(this.conn,this.codec,e)}},{key:"_handleStateExit",value:function(){this.conn.removeDataListener(),this.conn.removeErrorListener(),this.conn.removeCloseListener(),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=void 0}},{key:"_handleClose",value:function(){this.conn.close()}}]),t}(eG),eY=function(e){function t(e){var n;return(0,i._)(this,t),n=(0,ek._)(this,t,[e]),(0,c._)(n,"state","Handshaking"),(0,c._)(n,"conn",void 0),(0,c._)(n,"listeners",void 0),(0,c._)(n,"handshakeTimeout",void 0),(0,c._)(n,"onHandshakeData",function(e){var t=n.codec.fromBuffer(e);t.ok?n.listeners.onHandshake(t.value):n.listeners.onInvalidHandshake("could not parse handshake message: ".concat(t.reason),"MALFORMED_HANDSHAKE")}),n.conn=e.conn,n.listeners=e.listeners,n.handshakeTimeout=setTimeout(function(){n.listeners.onHandshakeTimeout()},n.options.handshakeTimeoutMs),n.conn.setDataListener(n.onHandshakeData),n.conn.setErrorListener(n.listeners.onConnectionErrored),n.conn.setCloseListener(n.listeners.onConnectionClosed),n}return(0,eE._)(t,e),(0,a._)(t,[{key:"loggingMetadata",get:function(){return(0,o._)({},(0,eS._)((0,eC._)(t.prototype),"loggingMetadata",this),this.conn.loggingMetadata)}},{key:"sendHandshake",value:function(e){return ez(this.conn,this.codec,e)}},{key:"_handleStateExit",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleStateExit",this).call(this),this.conn.removeDataListener(),this.conn.removeErrorListener(),this.conn.removeCloseListener(),this.handshakeTimeout&&(clearTimeout(this.handshakeTimeout),this.handshakeTimeout=void 0)}},{key:"_handleClose",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleClose",this).call(this),this.conn.close()}}]),t}(eK),eX=function(e){function t(e){var n;return(0,i._)(this,t),n=(0,ek._)(this,t,[e]),(0,c._)(n,"state","Connected"),(0,c._)(n,"conn",void 0),(0,c._)(n,"listeners",void 0),(0,c._)(n,"heartbeatHandle",void 0),(0,c._)(n,"heartbeatMissTimeout",void 0),(0,c._)(n,"isActivelyHeartbeating",!1),(0,c._)(n,"onMessageData",function(e){var t=n.codec.fromBuffer(e);if(!t.ok)return void n.listeners.onInvalidMessage("could not parse message: ".concat(t.reason));var s=t.value;if(s.seq!==n.ack){if(s.seq<n.ack)null==(a=n.log)||a.debug("received duplicate msg (got seq: ".concat(s.seq,", wanted seq: ").concat(n.ack,"), discarding"),(0,u._)((0,o._)({},n.loggingMetadata),{transportMessage:s}));else{var r,i,a,c,l="received out-of-order msg, closing connection (got seq: ".concat(s.seq,", wanted seq: ").concat(n.ack,")");null==(c=n.log)||c.error(l,(0,u._)((0,o._)({},n.loggingMetadata),{transportMessage:s,tags:["invariant-violation"]})),n.telemetry.span.setStatus({code:_.SpanStatusCode.ERROR,message:l}),n.conn.close()}return}(null==(r=n.log)||r.debug("received msg",(0,u._)((0,o._)({},n.loggingMetadata),{transportMessage:s})),n.updateBookkeeping(s.ack,s.seq),(1&s.controlFlags)!=1)?n.listeners.onMessage(s):(null==(i=n.log)||i.debug("discarding msg (ack bit set)",(0,u._)((0,o._)({},n.loggingMetadata),{transportMessage:s})),n.isActivelyHeartbeating||n.sendHeartbeat())}),n.conn=e.conn,n.listeners=e.listeners,n.conn.setDataListener(n.onMessageData),n.conn.setCloseListener(n.listeners.onConnectionClosed),n.conn.setErrorListener(n.listeners.onConnectionErrored),n}return(0,eE._)(t,e),(0,a._)(t,[{key:"updateBookkeeping",value:function(e,t){this.sendBuffer=this.sendBuffer.filter(function(t){return t.seq>=e}),this.ack=t+1,this.heartbeatMissTimeout&&clearTimeout(this.heartbeatMissTimeout),this.startMissingHeartbeatTimeout()}},{key:"assertSendOrdering",value:function(e){if(e.seq>this.seqSent+1){var t,n="invariant violation: would have sent out of order msg (seq: ".concat(e.seq,", expected: ").concat(this.seqSent," + 1)");throw null==(t=this.log)||t.error(n,(0,u._)((0,o._)({},this.loggingMetadata),{transportMessage:e,tags:["invariant-violation"]})),Error(n)}}},{key:"send",value:function(e){var t=this.constructMsg(e);this.assertSendOrdering(t),this.sendBuffer.push(t);var n=ez(this.conn,this.codec,t);return n.ok?this.seqSent=t.seq:this.listeners.onMessageSendFailure(t,n.reason),n}},{key:"sendBufferedMessages",value:function(){if(this.sendBuffer.length>0){null==(o=this.log)||o.info("sending ".concat(this.sendBuffer.length," buffered messages, starting at seq ").concat(this.nextSeq()),this.loggingMetadata);var e=!0,t=!1,n=void 0;try{for(var o,s,r=this.sendBuffer[Symbol.iterator]();!(e=(s=r.next()).done);e=!0){var i=s.value;this.assertSendOrdering(i);var a=ez(this.conn,this.codec,i);if(!a.ok)return this.listeners.onMessageSendFailure(i,a.reason),a;this.seqSent=i.seq}}catch(e){t=!0,n=e}finally{try{e||null==r.return||r.return()}finally{if(t)throw n}}}return{ok:!0,value:void 0}}},{key:"loggingMetadata",get:function(){return(0,o._)({},(0,eS._)((0,eC._)(t.prototype),"loggingMetadata",this),this.conn.loggingMetadata)}},{key:"startMissingHeartbeatTimeout",value:function(){var e=this,t=this.options.heartbeatsUntilDead,n=t*this.options.heartbeatIntervalMs;this.heartbeatMissTimeout=setTimeout(function(){var o;null==(o=e.log)||o.info("closing connection to ".concat(e.to," due to inactivity (missed ").concat(t," heartbeats which is ").concat(n,"ms)"),e.loggingMetadata),e.telemetry.span.addEvent("closing connection due to missing heartbeat"),e.conn.close()},n)}},{key:"startActiveHeartbeat",value:function(){var e=this;this.isActivelyHeartbeating=!0,this.heartbeatHandle=setInterval(function(){e.sendHeartbeat()},this.options.heartbeatIntervalMs)}},{key:"sendHeartbeat",value:function(){var e;null==(e=this.log)||e.debug("sending heartbeat",this.loggingMetadata),this.send({streamId:"heartbeat",controlFlags:1,payload:{type:"ACK"}})}},{key:"_handleStateExit",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleStateExit",this).call(this),this.conn.removeDataListener(),this.conn.removeCloseListener(),this.conn.removeErrorListener(),this.heartbeatHandle&&(clearInterval(this.heartbeatHandle),this.heartbeatHandle=void 0),this.heartbeatMissTimeout&&(clearTimeout(this.heartbeatMissTimeout),this.heartbeatMissTimeout=void 0)}},{key:"_handleClose",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleClose",this).call(this),this.conn.close()}}]),t}(eW),eZ=function(e){function t(e){var n;return(0,i._)(this,t),n=(0,ek._)(this,t,[e]),(0,c._)(n,"state","BackingOff"),(0,c._)(n,"listeners",void 0),(0,c._)(n,"backoffTimeout",void 0),n.listeners=e.listeners,n.backoffTimeout=setTimeout(function(){n.listeners.onBackoffFinished()},e.backoffMs),n}return(0,eE._)(t,e),(0,a._)(t,[{key:"_handleClose",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleClose",this).call(this)}},{key:"_handleStateExit",value:function(){(0,eS._)((0,eC._)(t.prototype),"_handleStateExit",this).call(this),this.backoffTimeout&&(clearTimeout(this.backoffTimeout),this.backoffTimeout=void 0)}}]),t}(eK),e0=new eH.ExtensionCodec;e0.register({type:0,encode:function(e){return(void 0===e?"undefined":(0,eb._)(e))!=="bigint"?null:e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?(0,eN.encode)(Number(e)):(0,eN.encode)(String(e))},decode:function(e){var t=(0,eB.decode)(e);if("string"!=typeof t&&"number"!=typeof t)throw new eR.DecodeError("unexpected BigInt source: ".concat(void 0===t?"undefined":(0,eb._)(t)));return BigInt(t)}});var e1=function(){function e(t){(0,i._)(this,e),this.codec=t}return(0,a._)(e,[{key:"toBuffer",value:function(e){try{return{ok:!0,value:this.codec.toBuffer(e)}}catch(e){return{ok:!1,reason:ev(e)}}}},{key:"fromBuffer",value:function(e){try{var t=this.codec.fromBuffer(e);if(!C.Value.Check(eo,t))return{ok:!1,reason:"transport message schema mismatch"};return{ok:!0,value:t}}catch(e){return{ok:!1,reason:ev(e)}}}}]),e}();function e2(e){return{id:e.id,from:e.from,to:e.to,seq:e.seq,ack:e.ack,seqSent:e.seqSent,sendBuffer:e.sendBuffer,telemetry:e.telemetry,options:e.options,log:e.log,tracer:e.tracer,protocolVersion:e.protocolVersion,codec:e.codec}}function e3(e){return(0,u._)((0,o._)({},e2(e)),{graceExpiryTime:e.graceExpiryTime})}var e4=function(e,t,n,s,r,i,a){var c,l="session-".concat(W()),d=ec(i,l,e,t),h=new e$({listeners:n,id:l,from:t,to:e,seq:0,ack:0,seqSent:0,graceExpiryTime:Date.now()+s.sessionDisconnectGraceMs,sendBuffer:[],telemetry:d,options:s,protocolVersion:r,tracer:i,log:a,codec:new e1(s.codec)});return null==(c=h.log)||c.info("session ".concat(h.id," created in NoConnection state"),(0,u._)((0,o._)({},h.loggingMetadata),{tags:["state-transition"]})),h},e6=function(e,t,n,s,r,i){var a,c=new eQ({conn:t,listeners:n,from:e,options:s,tracer:r,log:i,codec:new e1(s.codec)});return null==(a=c.log)||a.info("session created in WaitingForHandshake state",(0,u._)((0,o._)({},c.loggingMetadata),{tags:["state-transition"]})),c},e8={NoConnectionToBackingOff:function(e,t,n){var s,r=e3(e);e._handleStateExit();var i=new eZ((0,o._)({backoffMs:t,listeners:n},r));return null==(s=i.log)||s.info("session ".concat(i.id," transition from NoConnection to BackingOff"),(0,u._)((0,o._)({},i.loggingMetadata),{tags:["state-transition"]})),i},BackingOffToConnecting:function(e,t,n){var s,r=e3(e);e._handleStateExit();var i=new eJ((0,o._)({connPromise:t,listeners:n},r));return null==(s=i.log)||s.info("session ".concat(i.id," transition from BackingOff to Connecting"),(0,u._)((0,o._)({},i.loggingMetadata),{tags:["state-transition"]})),i},ConnectingToHandshaking:function(e,t,n){var s,r=e3(e);e._handleStateExit();var i=new eY((0,o._)({conn:t,listeners:n},r));return t.telemetry=el(i.tracer,t,i.telemetry),null==(s=i.log)||s.info("session ".concat(i.id," transition from Connecting to Handshaking"),(0,u._)((0,o._)({},i.loggingMetadata),{tags:["state-transition"]})),i},HandshakingToConnected:function(e,t){var n,s=e2(e),r=e.conn;e._handleStateExit();var i=new eX((0,o._)({conn:r,listeners:t},s));return i.startMissingHeartbeatTimeout(),null==(n=i.log)||n.info("session ".concat(i.id," transition from Handshaking to Connected"),(0,u._)((0,o._)({},i.loggingMetadata),{tags:["state-transition"]})),i},WaitingForHandshakeToConnected:function(e,t,n,s,r,i,a){var c,l=e.conn,d=e.from,h=e.options,g=t?e2(t):{id:n,from:d,to:s,seq:0,ack:0,seqSent:0,sendBuffer:[],telemetry:ec(e.tracer,n,s,d,r),options:h,tracer:e.tracer,log:e.log,protocolVersion:a,codec:new e1(h.codec)};e._handleStateExit(),null==t||t._handleStateExit();var f=new eX((0,o._)({conn:l,listeners:i},g));return f.startMissingHeartbeatTimeout(),l.telemetry=el(f.tracer,l,f.telemetry),null==(c=f.log)||c.info("session ".concat(f.id," transition from WaitingForHandshake to Connected"),(0,u._)((0,o._)({},f.loggingMetadata),{tags:["state-transition"]})),f},BackingOffToNoConnection:function(e,t){var n,s=e3(e);e._handleStateExit();var r=new e$((0,o._)({listeners:t},s));return null==(n=r.log)||n.info("session ".concat(r.id," transition from BackingOff to NoConnection"),(0,u._)((0,o._)({},r.loggingMetadata),{tags:["state-transition"]})),r},ConnectingToNoConnection:function(e,t){var n,s=e3(e);e.bestEffortClose(),e._handleStateExit();var r=new e$((0,o._)({listeners:t},s));return null==(n=r.log)||n.info("session ".concat(r.id," transition from Connecting to NoConnection"),(0,u._)((0,o._)({},r.loggingMetadata),{tags:["state-transition"]})),r},HandshakingToNoConnection:function(e,t){var n,s=e3(e);e.conn.close(),e._handleStateExit();var r=new e$((0,o._)({listeners:t},s));return null==(n=r.log)||n.info("session ".concat(r.id," transition from Handshaking to NoConnection"),(0,u._)((0,o._)({},r.loggingMetadata),{tags:["state-transition"]})),r},ConnectedToNoConnection:function(e,t){var n,s=e2(e),r=Date.now()+e.options.sessionDisconnectGraceMs;e.conn.close(),e._handleStateExit();var i=new e$((0,o._)({listeners:t,graceExpiryTime:r},s));return null==(n=i.log)||n.info("session ".concat(i.id," transition from Connected to NoConnection"),(0,u._)((0,o._)({},i.loggingMetadata),{tags:["state-transition"]})),i}},e5={entrypoint:e4,transition:{NoConnectionToBackingOff:e8.NoConnectionToBackingOff,BackingOffToConnecting:e8.BackingOffToConnecting,ConnectingToHandshaking:e8.ConnectingToHandshaking,HandshakingToConnected:e8.HandshakingToConnected,BackingOffToNoConnection:e8.BackingOffToNoConnection,ConnectingToNoConnection:e8.ConnectingToNoConnection,HandshakingToNoConnection:e8.HandshakingToNoConnection,ConnectedToNoConnection:e8.ConnectedToNoConnection}},e9={entrypoint:e6,transition:{WaitingForHandshakeToConnected:e8.WaitingForHandshakeToConnected,ConnectedToNoConnection:e8.ConnectedToNoConnection}},e7=function(){function e(t,n){(0,i._)(this,e),(0,c._)(this,"status",void 0),(0,c._)(this,"clientId",void 0),(0,c._)(this,"eventDispatcher",void 0),(0,c._)(this,"options",void 0),(0,c._)(this,"log",void 0),(0,c._)(this,"tracer",void 0),(0,c._)(this,"sessions",void 0),this.options=(0,o._)({},eA,n),this.eventDispatcher=new eO,this.clientId=t,this.status="open",this.sessions=new Map,this.tracer=S.trace.getTracer("river",ey)}return(0,a._)(e,[{key:"bindLogger",value:function(e,t){if("function"==typeof e){this.log=eL(new eI(e,t));return}this.log=eL(e)}},{key:"handleMsg",value:function(e){"open"===this.getStatus()&&this.eventDispatcher.dispatchEvent("message",e)}},{key:"addEventListener",value:function(e,t){this.eventDispatcher.addEventListener(e,t)}},{key:"removeEventListener",value:function(e,t){this.eventDispatcher.removeEventListener(e,t)}},{key:"protocolError",value:function(e){this.eventDispatcher.dispatchEvent("protocolError",e)}},{key:"close",value:function(){this.status="closed";var e=Array.from(this.sessions.values()),t=!0,n=!1,o=void 0;try{for(var s,r,i=e[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var a=r.value;this.deleteSession(a)}}catch(e){n=!0,o=e}finally{try{t||null==i.return||i.return()}finally{if(n)throw o}}this.eventDispatcher.dispatchEvent("transportStatus",{status:this.status}),this.eventDispatcher.removeAllListeners(),null==(s=this.log)||s.info("manually closed transport",{clientId:this.clientId})}},{key:"getStatus",value:function(){return this.status}},{key:"createSession",value:function(e){var t=this.sessions.get(e.to);if(t){var n,s="attempt to create session for ".concat(e.to," but active session (").concat(t.id,") already exists");throw null==(n=this.log)||n.error(s,(0,u._)((0,o._)({},e.loggingMetadata),{tags:["invariant-violation"]})),Error(s)}this.sessions.set(e.to,e),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"created",session:e}),this.eventDispatcher.dispatchEvent("sessionTransition",{state:e.state,id:e.id})}},{key:"updateSession",value:function(e){var t=this.sessions.get(e.to);if(!t){var n,s="attempt to transition session for ".concat(e.to," but no active session exists");throw null==(n=this.log)||n.error(s,(0,u._)((0,o._)({},e.loggingMetadata),{tags:["invariant-violation"]})),Error(s)}if(t.id!==e.id){var r,i="attempt to transition active session for ".concat(e.to," but active session (").concat(t.id,") is different from handle (").concat(e.id,")");throw null==(r=this.log)||r.error(i,(0,u._)((0,o._)({},e.loggingMetadata),{tags:["invariant-violation"]})),Error(i)}this.sessions.set(e.to,e),this.eventDispatcher.dispatchEvent("sessionTransition",{state:e.state,id:e.id})}},{key:"deleteSession",value:function(e,t){if(!e._isConsumed){var n,o=e.loggingMetadata;o.tags&&(null==t?void 0:t.unhealthy)&&o.tags.push("unhealthy-session"),null==(n=e.log)||n.info("closing session ".concat(e.id),o),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"closing",session:e});var s=e.to;e.close(),this.sessions.delete(s),this.eventDispatcher.dispatchEvent("sessionStatus",{status:"closed",session:{id:e.id,to:s}})}}},{key:"onSessionGracePeriodElapsed",value:function(e){var t;null==(t=this.log)||t.info("session to ".concat(e.to," grace period elapsed, closing"),e.loggingMetadata),this.deleteSession(e)}},{key:"onConnectingFailed",value:function(e){var t=this,n=e8.ConnectingToNoConnection(e,{onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(n)}});return this.updateSession(n),n}},{key:"onConnClosed",value:function(e){var t,n=this;return t="Handshaking"===e.state?e8.HandshakingToNoConnection(e,{onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(t)}}):e8.ConnectedToNoConnection(e,{onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(t)}}),this.updateSession(t),t}},{key:"getSessionBoundSendFn",value:function(e,t){var n=this;if("open"!==this.getStatus())throw Error("cannot get a bound send function on a closed transport");return function(o){var s=n.sessions.get(e);if(!s)throw Error("session scope for ".concat(t," has ended (close), can't send"));if(s.id!==t||s._isConsumed)throw Error("session scope for ".concat(t," has ended (transition), can't send"));var r=s.send(o);if(!r.ok)throw Error(r.reason);return r.value}}}]),e}(),te=function(){function e(t){(0,i._)(this,e),(0,c._)(this,"budgetConsumed",void 0),(0,c._)(this,"intervalHandle",void 0),(0,c._)(this,"options",void 0),this.options=t,this.budgetConsumed=0}return(0,a._)(e,[{key:"getBackoffMs",value:function(){if(0===this.getBudgetConsumed())return 0;var e=Math.max(0,this.getBudgetConsumed()-1),t=Math.floor(Math.random()*this.options.maxJitterMs);return Math.min(this.options.baseIntervalMs*Math.pow(2,e),this.options.maxBackoffMs)+t}},{key:"totalBudgetRestoreTime",get:function(){return this.options.budgetRestoreIntervalMs*this.options.attemptBudgetCapacity}},{key:"consumeBudget",value:function(){this.stopLeak(),this.budgetConsumed=this.getBudgetConsumed()+1}},{key:"getBudgetConsumed",value:function(){return this.budgetConsumed}},{key:"hasBudget",value:function(){return this.getBudgetConsumed()<this.options.attemptBudgetCapacity}},{key:"startRestoringBudget",value:function(){var e=this;this.intervalHandle||(this.intervalHandle=setInterval(function(){var t=e.budgetConsumed;if(!t)return void e.stopLeak();var n=t-1;0!==n&&(e.budgetConsumed=n)},this.options.budgetRestoreIntervalMs))}},{key:"stopLeak",value:function(){this.intervalHandle&&(clearInterval(this.intervalHandle),this.intervalHandle=void 0)}},{key:"close",value:function(){this.stopLeak()}}]),e}(),tt=function(e){function t(e,n){var s;return(0,i._)(this,t),s=(0,ek._)(this,t,[e,n]),(0,c._)(s,"options",void 0),(0,c._)(s,"retryBudget",void 0),(0,c._)(s,"reconnectOnConnectionDrop",!0),(0,c._)(s,"handshakeExtensions",void 0),(0,c._)(s,"sessions",void 0),s.sessions=new Map,s.options=(0,o._)({},eV,n),s.retryBudget=new te(s.options),s}return(0,eE._)(t,e),(0,a._)(t,[{key:"extendHandshake",value:function(e){this.handshakeExtensions=e}},{key:"tryReconnecting",value:function(e){var t=this.sessions.get(e);!this.options.enableTransparentSessionReconnects&&t&&this.deleteSession(t),this.reconnectOnConnectionDrop&&"open"===this.getStatus()&&this.connect(e)}},{key:"createUnconnectedSession",value:function(e){var t=this,n=e5.entrypoint(e,this.clientId,{onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(n)}},this.options,J,this.tracer,this.log);return this.createSession(n),n}},{key:"onConnectingFailed",value:function(e){var n=(0,eS._)((0,eC._)(t.prototype),"onConnectingFailed",this).call(this,e);return this.tryReconnecting(n.to),n}},{key:"onConnClosed",value:function(e){var n=(0,eS._)((0,eC._)(t.prototype),"onConnClosed",this).call(this,e);return this.tryReconnecting(n.to),n}},{key:"onConnectionEstablished",value:function(e,t){var n=this,o=e5.transition.ConnectingToHandshaking(e,t,{onConnectionErrored:function(e){var t,s=ev(e);null==(t=n.log)||t.error("connection to ".concat(o.to," errored during handshake: ").concat(s),o.loggingMetadata)},onConnectionClosed:function(){var e;null==(e=n.log)||e.warn("connection to ".concat(o.to," closed during handshake"),o.loggingMetadata),n.onConnClosed(o)},onHandshake:function(e){n.onHandshakeResponse(o,e)},onInvalidHandshake:function(t,s){var r;null==(r=n.log)||r.error("invalid handshake: ".concat(t),o.loggingMetadata),n.deleteSession(e,{unhealthy:!0}),n.protocolError({type:eD.HandshakeFailed,code:s,message:t})},onHandshakeTimeout:function(){var e;null==(e=n.log)||e.error("connection to ".concat(o.to," timed out during handshake"),o.loggingMetadata),n.onConnClosed(o)},onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(o)}});return this.updateSession(o),this.sendHandshake(o),o}},{key:"rejectHandshakeResponse",value:function(e,t,n){var o,s;null==(o=e.conn.telemetry)||o.span.setStatus({code:_.SpanStatusCode.ERROR,message:t}),null==(s=this.log)||s.warn(t,n),this.deleteSession(e,{unhealthy:!0})}},{key:"onHandshakeResponse",value:function(e,t){var n,s=this;if(!C.Value.Check(et,t.payload))return void this.rejectHandshakeResponse(e,"received invalid handshake response",(0,u._)((0,o._)({},e.loggingMetadata),{transportMessage:t,validationErrors:(0,h._)(C.Value.Errors(et,t.payload))}));if(!t.payload.status.ok){var r=C.Value.Check(Y,t.payload.status.code),i="handshake failed: ".concat(t.payload.status.reason),a=e.to;this.rejectHandshakeResponse(e,i,(0,u._)((0,o._)({},e.loggingMetadata),{transportMessage:t})),r?this.tryReconnecting(a):this.protocolError({type:eD.HandshakeFailed,code:t.payload.status.code,message:i});return}if(t.payload.status.sessionId!==e.id){var c="session id mismatch: expected ".concat(e.id,", got ").concat(t.payload.status.sessionId);this.rejectHandshakeResponse(e,c,(0,u._)((0,o._)({},e.loggingMetadata),{transportMessage:t}));return}null==(n=this.log)||n.info("handshake from ".concat(t.from," ok"),(0,u._)((0,o._)({},e.loggingMetadata),{transportMessage:t}));var d=e5.transition.HandshakingToConnected(e,{onConnectionErrored:function(e){var t,n,o=ev(e);(0,l._)(e,Error)&&s.options.isFatalConnectionError(e)?(null==(t=s.log)||t.warn("connection to ".concat(d.to," fatally errored: ").concat(o),d.loggingMetadata),s.reconnectOnConnectionDrop=!1):null==(n=s.log)||n.warn("connection to ".concat(d.to," errored: ").concat(o),d.loggingMetadata)},onConnectionClosed:function(){var e;null==(e=s.log)||e.info("connection to ".concat(d.to," closed"),d.loggingMetadata),s.onConnClosed(d)},onMessage:function(e){s.handleMsg(e)},onInvalidMessage:function(e){var n;null==(n=s.log)||n.error("invalid message: ".concat(e),(0,u._)((0,o._)({},d.loggingMetadata),{transportMessage:t})),s.protocolError({type:eD.InvalidMessage,message:e}),s.deleteSession(d,{unhealthy:!0})},onMessageSendFailure:function(e,t){var n;null==(n=s.log)||n.error("failed to send message: ".concat(t),(0,u._)((0,o._)({},d.loggingMetadata),{transportMessage:e})),s.protocolError({type:eD.MessageSendFailure,message:t}),s.deleteSession(d,{unhealthy:!0})}});d.sendBufferedMessages().ok&&(this.updateSession(d),this.retryBudget.startRestoringBudget())}},{key:"connect",value:function(e){var t=this;if("open"!==this.getStatus()){null==(s=this.log)||s.info("transport state is no longer open, cancelling attempt to connect to ".concat(e));return}var n=null!=(r=this.sessions.get(e))?r:this.createUnconnectedSession(e);if("NoConnection"!==n.state){null==(i=this.log)||i.debug("session to ".concat(e," has state ").concat(n.state,", skipping connect attempt"),n.loggingMetadata);return}if(!this.retryBudget.hasBudget()){var o,s,r,i,a,c=this.retryBudget.getBudgetConsumed(),l="tried to connect to ".concat(e," but retry budget exceeded (more than ").concat(c," attempts in the last ").concat(this.retryBudget.totalBudgetRestoreTime,"ms)");null==(a=this.log)||a.error(l,n.loggingMetadata),this.protocolError({type:eD.RetriesExceeded,message:l});return}var u=this.retryBudget.getBackoffMs();null==(o=this.log)||o.info("attempting connection to ".concat(e," (").concat(u,"ms backoff)"),n.loggingMetadata),this.retryBudget.consumeBudget();var d=e5.transition.NoConnectionToBackingOff(n,u,{onBackoffFinished:function(){t.onBackoffFinished(d)},onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(d)}});this.updateSession(d)}},{key:"hardDisconnect",value:function(){var e=Array.from(this.sessions.values()),t=!0,n=!1,o=void 0;try{for(var s,r=e[Symbol.iterator]();!(t=(s=r.next()).done);t=!0){var i=s.value;this.deleteSession(i)}}catch(e){n=!0,o=e}finally{try{t||null==r.return||r.return()}finally{if(n)throw o}}}},{key:"onBackoffFinished",value:function(e){var t=this,n=e.tracer.startActiveSpan("connect",function(n){return(0,r._)(function(){var t,o;return(0,g._)(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,3,4]),[4,this.createNewOutgoingConnection(e.to)];case 1:return[2,s.sent()];case 2:throw o=ev(t=s.sent()),n.recordException(o),n.setStatus({code:_.SpanStatusCode.ERROR}),t;case 3:return n.end(),[7];case 4:return[2]}})}).call(t)}),s=e5.transition.BackingOffToConnecting(e,n,{onConnectionEstablished:function(e){var n;null==(n=t.log)||n.debug("connection to ".concat(s.to," established"),(0,o._)({},e.loggingMetadata,s.loggingMetadata)),t.onConnectionEstablished(s,e)},onConnectionFailed:function(e){var n,o=ev(e);null==(n=t.log)||n.error("error connecting to ".concat(s.to,": ").concat(o),s.loggingMetadata),t.onConnectingFailed(s)},onConnectionTimeout:function(){var e;null==(e=t.log)||e.error("connection to ".concat(s.to," timed out"),s.loggingMetadata),t.onConnectingFailed(s)},onSessionGracePeriodElapsed:function(){t.onSessionGracePeriodElapsed(s)}});this.updateSession(s)}},{key:"sendHandshake",value:function(e){return(0,r._)(function(){var t,n,s,r,i;return(0,g._)(this,function(a){switch(a.label){case 0:if(n=void 0,!this.handshakeExtensions)return[3,2];return[4,this.handshakeExtensions.construct()];case 1:n=a.sent(),a.label=2;case 2:var c,l,d,h,g,f,v;if(e._isConsumed)return[2];return l=(c={from:this.clientId,to:e.to,sessionId:e.id,expectedSessionState:{nextExpectedSeq:e.ack,nextSentSeq:e.nextSeq()},metadata:n,tracing:ea(e.telemetry.ctx)}).from,d=c.to,h=c.sessionId,g=c.expectedSessionState,f=c.metadata,v=c.tracing,s={id:W(),from:l,to:d,seq:0,ack:0,streamId:W(),controlFlags:0,tracing:v,payload:{type:"HANDSHAKE_REQ",protocolVersion:J,sessionId:h,expectedSessionState:g,metadata:f}},null==(t=this.log)||t.debug("sending handshake request to ".concat(e.to),(0,u._)((0,o._)({},e.loggingMetadata),{transportMessage:s})),(r=e.sendHandshake(s)).ok||(null==(i=this.log)||i.error("failed to send handshake request: ".concat(r.reason),(0,u._)((0,o._)({},e.loggingMetadata),{transportMessage:s})),this.protocolError({type:eD.MessageSendFailure,message:r.reason}),this.deleteSession(e,{unhealthy:!0})),[2]}})}).call(this)}},{key:"close",value:function(){this.retryBudget.close(),(0,eS._)((0,eC._)(t.prototype),"close",this).call(this)}}]),t}(e7);function tn(e,t){var n,s;return(0,i._)(this,tn),n=(0,ek._)(this,tn,[e,t]),(0,c._)(n,"options",void 0),(0,c._)(n,"handshakeExtensions",void 0),(0,c._)(n,"sessionHandshakeMetadata",new Map),(0,c._)(n,"sessions",new Map),(0,c._)(n,"pendingSessions",new Set),n.sessions=new Map,n.options=(0,o._)({},eF,t),null==(s=n.log)||s.info("initiated server transport",{clientId:n.clientId,protocolVersion:J}),n}(0,eE._)(tn,e7),(0,a._)(tn,[{key:"extendHandshake",value:function(e){this.handshakeExtensions=e}},{key:"deletePendingSession",value:function(e){e.close(),this.pendingSessions.delete(e)}},{key:"deleteSession",value:function(e,t){this.sessionHandshakeMetadata.delete(e.to),(0,eS._)((0,eC._)(tn.prototype),"deleteSession",this).call(this,e,t)}},{key:"handleConnection",value:function(e){var t,n=this;if("open"===this.getStatus()){null==(t=this.log)||t.info("new incoming connection",(0,u._)((0,o._)({},e.loggingMetadata),{clientId:this.clientId}));var s=!1,r=e9.entrypoint(this.clientId,e,{onConnectionClosed:function(){var e;null==(e=n.log)||e.warn("connection from unknown closed before handshake finished",r.loggingMetadata),n.deletePendingSession(r)},onConnectionErrored:function(e){var t,o=ev(e);null==(t=n.log)||t.warn("connection from unknown errored before handshake finished: ".concat(o),r.loggingMetadata),n.deletePendingSession(r)},onHandshakeTimeout:function(){var e;null==(e=n.log)||e.warn("connection from unknown timed out before handshake finished",r.loggingMetadata),n.deletePendingSession(r)},onHandshake:function(e){if(s){var t;null==(t=n.log)||t.error("received multiple handshake messages from pending session",(0,u._)((0,o._)({},r.loggingMetadata),{connectedTo:e.from,transportMessage:e})),n.deletePendingSession(r);return}s=!0,n.onHandshakeRequest(r,e)},onInvalidHandshake:function(e,t){var o;null==(o=n.log)||o.error("invalid handshake: ".concat(e),r.loggingMetadata),n.deletePendingSession(r),n.protocolError({type:eD.HandshakeFailed,code:t,message:e})}},this.options,this.tracer,this.log);this.pendingSessions.add(r)}}},{key:"rejectHandshakeRequest",value:function(e,t,n,s,r){null==(i=e.conn.telemetry)||i.span.setStatus({code:_.SpanStatusCode.ERROR,message:n}),null==(a=this.log)||a.warn(n,r);var i,a,c,l=es({from:this.clientId,to:t,status:{ok:!1,code:s,reason:n}}),d=e.sendHandshake(l);if(!d.ok){null==(c=this.log)||c.error("failed to send handshake response: ".concat(d.reason),(0,u._)((0,o._)({},e.loggingMetadata),{transportMessage:l})),this.protocolError({type:eD.MessageSendFailure,message:d.reason}),this.deletePendingSession(e);return}this.protocolError({type:eD.HandshakeFailed,code:s,message:n}),this.deletePendingSession(e)}},{key:"onHandshakeRequest",value:function(e,t){return(0,r._)(function(){var n,s,r,i,a,c,l,d,f,v,p,m,_,y,k,S,E,b,T,M;return(0,g._)(this,function(g){switch(g.label){case 0:var w;if(n=this,!C.Value.Check(Q,t.payload))return this.rejectHandshakeRequest(e,t.from,"received invalid handshake request","MALFORMED_HANDSHAKE",(0,u._)((0,o._)({},e.loggingMetadata),{transportMessage:t,connectedTo:t.from,validationErrors:(0,h._)(C.Value.Errors(Q,t.payload))})),[2];if(w=r=t.payload.protocolVersion,!$.includes(w))return this.rejectHandshakeRequest(e,t.from,"expected protocol version oneof [".concat($.toString(),"], got ").concat(r),"PROTOCOL_VERSION_MISMATCH",(0,u._)((0,o._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];if(i={},!this.handshakeExtensions)return[3,2];if(!C.Value.Check(this.handshakeExtensions.schema,t.payload.metadata))return this.rejectHandshakeRequest(e,t.from,"received malformed handshake metadata","MALFORMED_HANDSHAKE_META",(0,u._)((0,o._)({},e.loggingMetadata),{connectedTo:t.from,validationErrors:(0,h._)(C.Value.Errors(this.handshakeExtensions.schema,t.payload.metadata))})),[2];return a=this.sessionHandshakeMetadata.get(t.from),[4,this.handshakeExtensions.validate(t.payload.metadata,a)];case 1:if(c=g.sent(),e._isConsumed)return[2];if(C.Value.Check(X,c))return this.rejectHandshakeRequest(e,t.from,"rejected by handshake handler",c,(0,u._)((0,o._)({},e.loggingMetadata),{connectedTo:t.from,clientId:this.clientId})),[2];i=c,g.label=2;case 2:if(l="new session",d=t.payload.expectedSessionState.nextExpectedSeq,f=t.payload.expectedSessionState.nextSentSeq,v=this.sessions.get(t.from),this.options.enableTransparentSessionReconnects&&v&&v.id===t.payload.sessionId){if(l="transparent reconnection",p=v.nextSeq(),f>(m=v.ack))return this.rejectHandshakeRequest(e,t.from,"client is in the future: server wanted next message to be ".concat(m," but client would have sent ").concat(f),"SESSION_STATE_MISMATCH",(0,u._)((0,o._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];if(p>d)return this.rejectHandshakeRequest(e,t.from,"server is in the future: client wanted next message to be ".concat(d," but server would have sent ").concat(p),"SESSION_STATE_MISMATCH",(0,u._)((0,o._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];"NoConnection"!==v.state&&(v=_=e9.transition.ConnectedToNoConnection(v,{onSessionGracePeriodElapsed:function(){n.onSessionGracePeriodElapsed(_)}}),this.updateSession(v))}else v&&(l="hard reconnection",null==(y=this.log)||y.info("client is reconnecting to a new session (".concat(t.payload.sessionId,") with an old session (").concat(v.id,") already existing, closing old session"),(0,u._)((0,o._)({},e.loggingMetadata),{connectedTo:t.from,sessionId:t.payload.sessionId})),this.deleteSession(v),v=void 0);if(!v&&(f>0||d>0))return l="unknown session",k=this.options.enableTransparentSessionReconnects?"client is trying to reconnect to a session the server don't know about: ".concat(t.payload.sessionId):"client is attempting a transparent reconnect to a session but the server does not support it: ".concat(t.payload.sessionId),this.rejectHandshakeRequest(e,t.from,k,"SESSION_STATE_MISMATCH",(0,u._)((0,o._)({},e.loggingMetadata),{connectedTo:t.from,transportMessage:t})),[2];if(S=t.payload.sessionId,null==(s=this.log)||s.info("handshake from ".concat(t.from," ok (").concat(l,"), responding with handshake success"),(0,u._)((0,o._)({},e.loggingMetadata),{connectedTo:t.from})),E=es({from:this.clientId,to:t.from,status:{ok:!0,sessionId:S}}),!(b=e.sendHandshake(E)).ok)return null==(T=this.log)||T.error("failed to send handshake response: ".concat(b.reason),(0,u._)((0,o._)({},e.loggingMetadata),{transportMessage:E})),this.protocolError({type:eD.MessageSendFailure,message:b.reason}),this.deletePendingSession(e),[2];if(this.pendingSessions.delete(e),!(M=e9.transition.WaitingForHandshakeToConnected(e,v,S,t.from,t.tracing,{onConnectionErrored:function(e){var t,o=ev(e);null==(t=n.log)||t.warn("connection to ".concat(M.to," errored: ").concat(o),M.loggingMetadata)},onConnectionClosed:function(){var e;null==(e=n.log)||e.info("connection to ".concat(M.to," closed"),M.loggingMetadata),n.onConnClosed(M)},onMessage:function(e){n.handleMsg(e)},onInvalidMessage:function(e){var s;null==(s=n.log)||s.error("invalid message: ".concat(e),(0,u._)((0,o._)({},M.loggingMetadata),{transportMessage:t})),n.protocolError({type:eD.InvalidMessage,message:e}),n.deleteSession(M,{unhealthy:!0})},onMessageSendFailure:function(e,t){var s;null==(s=n.log)||s.error("failed to send message: ".concat(t),(0,u._)((0,o._)({},M.loggingMetadata),{transportMessage:e})),n.protocolError({type:eD.MessageSendFailure,message:t}),n.deleteSession(M,{unhealthy:!0})}},r)).sendBufferedMessages().ok)return[2];return this.sessionHandshakeMetadata.set(M.to,i),v?this.updateSession(M):this.createSession(M),M.startActiveHeartbeat(),[2]}})}).call(this)}}]);var to=function(){function e(){(0,i._)(this,e),(0,c._)(this,"id",void 0),(0,c._)(this,"telemetry",void 0),(0,c._)(this,"dataListener",void 0),(0,c._)(this,"closeListener",void 0),(0,c._)(this,"errorListener",void 0),this.id="conn-".concat(W())}return(0,a._)(e,[{key:"loggingMetadata",get:function(){var e,t={connId:this.id};if(null==(e=this.telemetry)?void 0:e.span.isRecording()){var n=this.telemetry.span.spanContext();t.telemetry={traceId:n.traceId,spanId:n.spanId}}return t}},{key:"onData",value:function(e){var t;null==(t=this.dataListener)||t.call(this,e)}},{key:"onError",value:function(e){var t;null==(t=this.errorListener)||t.call(this,e)}},{key:"onClose",value:function(){var e,t;null==(e=this.closeListener)||e.call(this),null==(t=this.telemetry)||t.span.end()}},{key:"setDataListener",value:function(e){this.dataListener=e}},{key:"removeDataListener",value:function(){this.dataListener=void 0}},{key:"setCloseListener",value:function(e){this.closeListener=e}},{key:"removeCloseListener",value:function(){this.closeListener=void 0}},{key:"setErrorListener",value:function(e){this.errorListener=e}},{key:"removeErrorListener",value:function(){this.errorListener=void 0}}]),e}(),ts=function(e){function t(e,n){var o;return(0,i._)(this,t),o=(0,ek._)(this,t,["websocket closed with code and reason: ".concat(e," - ").concat(n)]),(0,c._)(o,"code",void 0),(0,c._)(o,"reason",void 0),o.code=e,o.reason=n,o}return(0,eE._)(t,e),t}((0,eT._)(Error)),tr=function(e){function t(e,n){(0,i._)(this,t),o=(0,ek._)(this,t),(0,c._)(o,"ws",void 0),(0,c._)(o,"extras",void 0),o.ws=e,o.extras=n,o.ws.binaryType="arraybuffer";var o,s=!1;return o.ws.onerror=function(){s=!0},o.ws.onclose=function(e){var t=e.code,n=e.reason;if(s){var r=new ts(t,n);o.onError(r)}o.onClose()},o.ws.onmessage=function(e){o.onData(e.data)},o}return(0,eE._)(t,e),(0,a._)(t,[{key:"loggingMetadata",get:function(){var e=(0,eS._)((0,eC._)(t.prototype),"loggingMetadata",this);return this.extras&&(e.extras=this.extras),e}},{key:"send",value:function(e){try{return this.ws.send(e),!0}catch(e){return!1}}},{key:"close",value:function(){this.ws.close(1e3)}}]),t}(to),ti=function(e){function t(e,n,o){var s;return(0,i._)(this,t),s=(0,ek._)(this,t,[n,o]),(0,c._)(s,"wsGetter",void 0),s.wsGetter=e,s}return(0,eE._)(t,e),(0,a._)(t,[{key:"createNewOutgoingConnection",value:function(e){return(0,r._)(function(){var t,n,s,r;return(0,g._)(this,function(i){switch(i.label){case 0:return null==(t=this.log)||t.info("establishing a new websocket to ".concat(e),{clientId:this.clientId,connectedTo:e}),[4,this.wsGetter(e)];case 1:return s=i.sent(),[4,new Promise(function(e,t){s.readyState===s.OPEN?e():s.readyState===s.CLOSING||s.readyState===s.CLOSED?t(Error("ws is closing or closed")):(s.onopen=function(){e()},s.onclose=function(e){t(Error(e.reason))},s.onerror=function(e){t(Error(e.message))})})];case 2:return i.sent(),r=new tr(s),null==(n=this.log)||n.info("raw websocket to ".concat(e," ok"),(0,o._)({clientId:this.clientId,connectedTo:e},r.loggingMetadata)),[2,r]}})}).call(this)}}]),t}(tt),ta=f.Type.Object({token:f.Type.String()}),tc="SERVER",tl={codec:{toBuffer:function(e){return(0,eN.encode)(e,{ignoreUndefined:!0,extensionCodec:e0})},fromBuffer:function(e){var t=(0,eB.decode)(e,{extensionCodec:e0});if((void 0===t?"undefined":(0,eb._)(t))!=="object"||null===t)throw Error("unpacked msg is not an object");return t}},heartbeatIntervalMs:2500,heartbeatsUntilDead:4,sessionDisconnectGraceMs:1e4,connectionTimeoutMs:1e4,handshakeTimeoutMs:1e4};(0,o._)({},tl);var tu=[4002,4004],td=(0,u._)((0,o._)({},tl),{baseIntervalMs:250,maxJitterMs:250,maxBackoffMs:32e3,attemptBudgetCapacity:5,budgetRestoreIntervalMs:500,isFatalConnectionError:function(e){return!!((0,l._)(e,ts)&&tu.includes(e.code))}});e.s(["PID2_SERVER_ID",()=>tc,"RIVER_VERSION",()=>ey,"RiverProtocolError",()=>eD,"default",0,function(e,t,n,s){var i,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"info",c=arguments.length>5?arguments[5]:void 0,l=new ti(t,e,c?(0,o._)({},td,c):td);return l.bindLogger(s,a),{client:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n.handshakeOptions&&e.extendHandshake(n.handshakeOptions);var s=(0,o._)({},eh,n);return s.eagerlyConnect&&e.connect(t),function e(t,n){return new Proxy(ed,{get:function(o,s){if("string"==typeof s)return e(t,(0,h._)(n).concat([s]))},apply:function(e,o,s){return t({path:n,args:s})}})}(function(n){var r=(0,d._)((0,h._)(n.path),3),i=r[0],a=r[1],c=r[2];if(!(i&&a&&c))throw Error("invalid river call, ensure the service and procedure you are calling exists");var l=(0,d._)(n.args,2),g=l[0],f=l[1];if(s.connectOnInvoke&&!e.sessions.has(t)&&e.connect(t),"rpc"!==c&&"subscribe"!==c&&"stream"!==c&&"upload"!==c)throw Error("invalid river call, unknown procedure type ".concat(c));return function(e,t,n,s,r,i,a){if("closed"===t.getStatus()){var c,l,d,g;return c=e,l=new j,d=V({code:b,message:"transport is closed"}),l._pushValue(d),l._triggerClose(),(g=new U({writeCb:function(){},closeCb:function(){}})).close(),eg(c,l,g)}var f,v,p,_,k,E,T,w=null!=(T=t.sessions.get(n))?T:t.createUnconnectedSession(n),x=t.getSessionBoundSendFn(n,w.id),I="rpc"===e||"subscription"===e,L=W(),R=(f=t.tracer,p=y.context.active(),_=f.startSpan("river.client.".concat(r,".").concat(i),{attributes:{component:"river","river.method.kind":e,"river.method.service":r,"river.method.name":i,"river.streamId":L,"span.kind":"client"},links:[{context:w.telemetry.span.spanContext()}],kind:m.SpanKind.CLIENT},p),k=S.trace.setSpan(p,_),E=(0,u._)((0,o._)({},w.loggingMetadata),{transportMessage:{procedureName:i,serviceName:r}}),_.isRecording()&&(E.telemetry={traceId:_.spanContext().traceId,spanId:_.spanContext().spanId}),null==(v=w.log)||v.info("invoked ".concat(r,".").concat(i),E),{span:_,ctx:k}),H=R.span,N=R.ctx,D=!0,O=new U({writeCb:function(e){x({streamId:L,payload:e,controlFlags:0})},closeCb:function(){H.addEvent("reqWritable closed"),!I&&D&&x(er(L)),q.isClosed()&&F()}}),q=new j,A=function(){q._triggerClose(),H.addEvent("resReadable closed"),O.isClosed()&&F()};function F(){t.removeEventListener("message",K),t.removeEventListener("sessionStatus",J),null==a||a.removeEventListener("abort",G),H.end()}function G(){q.isClosed()&&O.isClosed()||(H.addEvent("sending cancel"),D=!1,q.isClosed()||(q._pushValue(V({code:M,message:"cancelled by client"})),A()),O.close(),x(ei(L,V({code:M,message:"cancelled by client"}))))}function K(e){var n,o,s,r,i,a;if(e.streamId===L){if(e.to!==t.clientId){null==(n=t.log)||n.error("got stream message from unexpected client",{clientId:t.clientId,transportMessage:e});return}if((4&e.controlFlags)==4){D=!1,H.addEvent("received cancel"),C.Value.Check(B,e.payload)?o=e.payload:(o=V({code:M,message:"stream cancelled with invalid payload"}),null==(s=t.log)||s.warn("got stream cancel without a valid protocol error",{clientId:t.clientId,transportMessage:e,validationErrors:(0,h._)(C.Value.Errors(B,e.payload))})),q.isClosed()||(q._pushValue(o),A()),O.close();return}if(q.isClosed()){H.recordException("received message after response stream is closed"),null==(r=t.log)||r.error("received message after response stream is closed",{clientId:t.clientId,transportMessage:e});return}C.Value.Check(z,e.payload)||(C.Value.Check(P,e.payload)?q._pushValue(e.payload):null==(i=t.log)||i.error("Got non-control payload, but was not a valid result",{clientId:t.clientId,transportMessage:e,validationErrors:(0,h._)(C.Value.Errors(P,e.payload))})),(8&e.controlFlags)==8&&(H.addEvent("received response close"),q.isClosed()?null==(a=t.log)||a.error("received stream close but readable was already closed"):A())}}function J(e){"closing"===e.status&&e.session.to===n&&w.id===e.session.id&&(D=!1,q.isClosed()||(q._pushValue(V({code:b,message:"".concat(n," unexpectedly disconnected")})),A()),O.close())}return null==a||a.addEventListener("abort",G),t.addEventListener("message",K),t.addEventListener("sessionStatus",J),x({streamId:L,serviceName:r,procedureName:i,tracing:ea(N),payload:s,controlFlags:I?10:2}),I&&O.close(),eg(e,q,O,t.log)}("subscribe"===c?"subscription":c,e,t,g,i,a,f?f.signal:void 0)},[])}(l,tc,{eagerlyConnect:!1,connectOnInvoke:!1,handshakeOptions:(i=n,{schema:ta,construct:function(){return(0,r._)(function(){var e;return(0,g._)(this,function(t){switch(t.label){case 0:return e={},[4,i()];case 1:return[2,(e.token=t.sent(),e)]}})})()}})}),transport:l}}],638472)},37292,e=>{"use strict";var t=e.i(878420),n=e.i(64386),o=e.i(389959),s=e.i(131141),r=e.i(541793),i=e.i(161322),a=e.i(719518),c=e.i(57168),l=(0,r.atom)(null),u=(0,r.atom)(null,function(e,o,s){var r=s.error,i=s.tags,a=s.extras,u=s.componentStack,d=s.origin,h=(0,n._)((0,t._)({},i),{origin:d});"statusCode"in r?h.statusCode=r.statusCode:"status"in r&&(h.statusCode=r.status),e(l)||o(l,{eventId:(0,c.captureFatalWorkspaceException)(r,{tags:h,extras:a,componentStack:u}),error:r,componentStack:u,sentry:{tags:h,extras:a},origin:d})}),d=(0,r.atom)(null,function(e,t){t(l,null)}),h=(0,r.atom)(new Map);function g(){return(0,a.useAtomCallback)((0,o.useCallback)(function(e,t,n){var o=n.filePath;return e(h).get(o)},[]))}function f(){return(0,a.useAtomCallback)((0,o.useCallback)(function(e,t,n){var o=n.filePath,r=n.version;t(h,function(e){return(0,s.produce)(e,function(e){e.set(o,r)})})},[]))}function v(){return(0,a.useAtomCallback)((0,o.useCallback)(function(e,t,n){var o=n.filePath;t(h,function(e){return(0,s.produce)(e,function(e){e.delete(o)})})},[]))}function p(){return(0,i.useSetAtom)(u)}function m(){return[(0,i.useAtomValue)(l),p()]}function _(){return(0,i.useSetAtom)(d)}e.s(["useBsod",()=>m,"useClearBsod",()=>_,"useDeleteBsodFilePathVersion",()=>v,"useGetBsodFileVersionByPath",()=>g,"useSetBsodFilePathVersion",()=>f,"useThrowBsod",()=>p])},299798,400081,400082,e=>{"use strict";var t=e.i(530658),n=e.i(346715),o=e.i(389959),s=e.i(33699),r=e.i(297083),i=e.i(878420),a=e.i(64386),c=e.i(817556),l=e.i(276385),u=e.i(906368),d=e.i(908410),h=e.i(626430),g=e.i(638472),f=e.i(993796),v=e.i(664152),p=e.i(441329),m=e.i(668106),_=e.i(116680),y=e.i(37292),k=e.i(376847),S=e.i(635984),C=(0,o.createContext)(null);function E(){return(0,o.useContext)(C)}function b(e){var t=e.currentUsername,n=e.replId,o=e.children;return(0,l.jsx)(x,{replId:n,currentUsername:t,children:o})}var T=function(e,t,n){var o;if(v.logger[null!=n?n:"info"](e,{river:t,riverTarget:"pid2",riverVersion:g.RIVER_VERSION}),null==t||null==(o=t.tags)?void 0:o.includes("invariant-violation")){var s=Error(e);u.withScope(function(e){e.setTag("pid2",!0),e.setExtras(t),u.captureException(s)})}},M=window.location.search.includes("debug=1")?function(e,t,n){console[null!=n?n:"info"](e,t),T(e,t,n)}:T,w=s.default.env.CI?{connectionTimeoutMs:6e4,handshakeTimeoutMs:6e4,sessionDisconnectGraceMs:12e4}:{};function x(e){var n=e.currentUsername,s=e.replId,v=e.children,E=(0,y.useThrowBsod)(),b=(0,t._)((0,o.useState)(!1),2),T=b[0],x=b[1],I=(0,p.useIsInMobileWorkspace)(),L=(0,f.useFlag)({controlName:"flag-pid2-no-bg-reconnect"})&&I,R=(0,t._)((0,o.useState)(null),2),H=R[0],B=R[1],N=(0,o.useRef)({});return(0,o.useEffect)(function(){var e="".concat(n,"-").concat((0,d.nanoid)(4)),o=(0,t._)(function(e){var t,n=e.clientId,o=e.replId,s=e.onSessionStatusChange,i=e.onSessionTransitionChange,a=e.onProtocolError,l=e.onRetryBudgetExhausted,u=e.logLevel,d=e.overrideLog,f=e.overrideGetWs,v=e.overrideGetToken,p=e.noBgReconnectEnabled,y=(0,g.default)(n,function(){return(0,r._)(function(){var e;return(0,c._)(this,function(n){return e=Date.now(),M("pid2: getting ws"),[2,(null!=f?f:function(){return(0,r._)(function(){var e,n;return(0,c._)(this,function(s){switch(s.label){case 0:return[4,(0,r._)(function(){var e;return(0,c._)(this,function(t){switch(t.label){case 0:return e={replId:o,isLoggedIn:!0},[4,(0,S.getPid2Version)()];case 1:return e.requestedPid2Version=t.sent(),e.format=h.api.token.ReplToken.WireFormat.RIVER,[4,(0,_.default)()];case 2:return[4,m.default.apply(void 0,[(e.overrideClusterMetadata=t.sent(),e)])];case 3:return[2,t.sent()]}})})()];case 1:return(n=new URL((e=s.sent()).gurl)).pathname="/wsv2/".concat(e.token),t=e.token,[2,new WebSocket(n.toString())]}})})()})(o).finally(function(){M("pid2: ws open",{extras:{duration:Date.now()-e}})})]})})()},null!=v?v:function(){return t},null!=d?d:M,u,w);function k(){M("pid2: visibility: attempting connection",{extras:{noBgReconnectEnabled:p}}),y.transport.reconnectOnConnectionDrop=!0,y.transport.connect(g.PID2_SERVER_ID)}function C(){M("pid2: visibility: disabling reconnect",{extras:{noBgReconnectEnabled:p}}),y.transport.reconnectOnConnectionDrop=!1}function E(e){null==s||s(e),"closed"===e.status&&setTimeout(function(){"visible"===document.visibilityState&&"open"===y.transport.getStatus()&&k()},0)}function b(e){null==i||i(e)}function T(e){if(e.type===g.RiverProtocolError.RetriesExceeded){C(),y.transport.retryBudget.startRestoringBudget(),l();return}a(e),y.transport.close()}function x(){"visible"===document.visibilityState?k():p&&C()}return y.transport.addEventListener("protocolError",T),y.transport.addEventListener("sessionStatus",E),y.transport.addEventListener("sessionTransition",b),document.addEventListener("visibilitychange",x),window.addEventListener("online",k),window.addEventListener("offline",C),!0===window.navigator.onLine&&k(),[y,function(){y.transport.removeEventListener("sessionStatus",E),y.transport.removeEventListener("sessionTransition",b),y.transport.removeEventListener("protocolError",T),y.transport.close(),document.removeEventListener("visibilitychange",x),window.removeEventListener("online",k),window.removeEventListener("offline",C)}]}({clientId:e,replId:s,onRetryBudgetExhausted:function(){M("pid2: retry budget exhausted, showing refresh modal",{extras:{noBgReconnectEnabled:L}},"warn"),x(!0)},onSessionStatusChange:function(t){"created"===t.status?(N.current.sessionStart=Date.now(),M("pid2: session started",{sessionId:t.session.id,clientId:e,extras:{noBgReconnectEnabled:L}})):"closed"===t.status&&N.current.sessionStart&&M("pid2: session ended",{sessionId:t.session.id,clientId:e,extras:{sessionDuration:Date.now()-N.current.sessionStart}}),("created"===t.status||"closed"===t.status)&&u.addBreadcrumb({category:"pid2",message:"session ".concat(t.status),data:t})},onSessionTransitionChange:function(t){"Connecting"===t.state&&(N.current.connectionStart=Date.now(),M("pid2: connecting",{sessionId:t.id,clientId:e})),"Handshaking"===t.state&&(N.current.handshakeStart=Date.now()),"Connected"===t.state&&(N.current.connectionStart&&N.current.handshakeStart&&M("pid2: connected",{sessionId:t.id,clientId:e,extras:(0,a._)((0,i._)({},N.current),{connectionDuration:N.current.handshakeStart-N.current.connectionStart,handshakeDuration:Date.now()-N.current.handshakeStart,totalDuration:Date.now()-N.current.connectionStart})}),N.current.connectionStart=void 0,N.current.handshakeStart=void 0),"NoConnection"===t.state&&(M("pid2: no connection"),N.current.connectionStart=void 0,N.current.handshakeStart=void 0),u.addBreadcrumb({category:"pid2",message:"session transition ".concat(t.state),data:t})},onProtocolError:function(e){(u.addBreadcrumb({category:"pid2",message:"protocol error",data:e}),e.type===g.RiverProtocolError.HandshakeFailed)?x(!0):E({error:Error(e.message),tags:{pid2:!0},origin:"pid2: RiverClientProvider",extras:e})},logLevel:"info",noBgReconnectEnabled:L}),2),l=o[0],f=o[1];return B(l),function(){B(null),f()}},[n,s,E,L]),(0,l.jsxs)(C.Provider,{value:H,children:[(0,l.jsx)(k.default,{isOpen:T}),v]})}e.s(["Pid2Provider",()=>b,"usePid2InternalsContextDoNotUseOrYouWillBeFired",()=>E],400081);var I=e.i(971131);function L(){var e=E(),n=(0,t._)((0,o.useState)(null),2),s=n[0],r=n[1];return(0,o.useEffect)(function(){var t=function(){(0,I.flushSync)(function(){r(null)})},n=function(e){"created"===e.status?r({id:e.session.id,from:e.session.from,to:e.session.to}):"closed"===e.status&&t()};if(e){var o=e.transport.sessions.get(g.PID2_SERVER_ID);return o&&n({status:"created",session:o}),e.transport.addEventListener("sessionStatus",n),function(){t(),e.transport.removeEventListener("sessionStatus",n)}}},[e]),s}function R(e,s){var r,i,a=E(),c=L(),l=null!=(i=null==a?void 0:a.client)?i:null,u=(0,o.useRef)(null),d=(r=(0,t._)((0,o.useState)(),2)[1],(0,o.useCallback)(function(e){try{r(function(){throw e})}catch(e){}},[]));(0,o.useEffect)(function(){if(u.current&&(u.current.abort(),u.current=null),l&&c){var t=new AbortController;u.current=t;var n=t.signal,o=[];n.addEventListener("abort",function(){var e=[],t=!0,n=!1,s=void 0;try{for(var r,i=o[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var a=r.value;try{a()}catch(t){e.push(t)}}}catch(e){n=!0,s=e}finally{try{t||null==i.return||i.return()}finally{if(n)throw s}}e.length&&(1===e.length?d(e[0]):"undefined"!=typeof AggregateError?d(AggregateError(e,"Multiple errors occurred during cleanup")):d(Error("Multiple errors occurred during cleanup")))});var s=function(e){if(n.aborted)try{e()}catch(e){d(e)}else o.push(e)};try{Promise.resolve(e(l,{session:c,signal:n,addCleanup:s})).then(function(e){e&&s(e)}).catch(function(e){t.abort(),d(e)})}catch(e){throw t.abort(),e}return function(){t.abort()}}},[l,c,d].concat((0,n._)(s)))}e.s(["usePid2Session",()=>L],400082),e.s(["usePid2",()=>R],299798)}]);

//# debugId=c8f42d5a-218f-f215-ea75-6febf38a36da
//# sourceMappingURL=78ac50ffcd084ba7.js.map