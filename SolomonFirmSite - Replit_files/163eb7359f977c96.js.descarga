;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="10d52b76-ddf8-6cec-ffaf-e42364059a07")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,353579,e=>{"use strict";var r=e.i(937500);e.i(297083),e.i(817556);var t=e.i(626430);function n(e){var n=e.split(".");if(4!==n.length)throw Error("Invalid token: should have exactly 4 parts: "+e);for(var o=n[2].replace(/-/g,"+").replace(/_/g,"/");o.length%4;)o+="=";var i=window.atob(o);if(i.length<64)throw Error("Invalid token: signed part is too short: "+i.length);var a=i.substring(0,i.length-64);return t.api.token.ReplToken.decode(r.Buffer.from(a,"base64"))}function o(e){var r,t=null!=(r=({"infra-staging":"platform-infra-staging",mark:"platform-replit"})[e])?r:"platform";return"https://zipper.".concat(e,".").concat(t,".replit.com")}e.s(["getZipperUrl",()=>o,"parseToken",()=>n])},240913,e=>{"use strict";var r=e.i(193060),t=(0,r.toRelativeFsPath)("."),n=(0,r.toRelativeFsPath)(".env"),o=(0,r.toRelativeFsPath)(".lesson"),i=(0,r.toRelativeFsPath)(".tutorial");e.s(["DOT_ENV",()=>n,"LESSON_PATH",()=>o,"ROOT_PATH",()=>t,"TUTORIAL_PATH",()=>i])},469546,(e,r,t)=>{var n,o=e.r(365738),i=function(e){e.version="1.2.2";var r=function(){for(var e=0,r=Array(256),t=0;256!=t;++t)e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=t)?-0x12477ce0^e>>>1:e>>>1)?-0x12477ce0^e>>>1:e>>>1)?-0x12477ce0^e>>>1:e>>>1)?-0x12477ce0^e>>>1:e>>>1)?-0x12477ce0^e>>>1:e>>>1)?-0x12477ce0^e>>>1:e>>>1)?-0x12477ce0^e>>>1:e>>>1)?-0x12477ce0^e>>>1:e>>>1,r[t]=e;return"undefined"!=typeof Int32Array?new Int32Array(r):r}(),t=function(e){var r=0,t=0,n=0,o="undefined"!=typeof Int32Array?new Int32Array(4096):Array(4096);for(n=0;256!=n;++n)o[n]=e[n];for(n=0;256!=n;++n)for(t=e[n],r=256+n;r<4096;r+=256)t=o[r]=t>>>8^e[255&t];var i=[];for(n=1;16!=n;++n)i[n-1]="undefined"!=typeof Int32Array?o.subarray(256*n,256*n+256):o.slice(256*n,256*n+256);return i}(r),n=t[0],o=t[1],i=t[2],a=t[3],s=t[4],l=t[5],c=t[6],u=t[7],f=t[8],d=t[9],h=t[10],p=t[11],v=t[12],y=t[13],m=t[14];e.table=r,e.bstr=function(e,t){for(var n=-1^t,o=0,i=e.length;o<i;)n=n>>>8^r[(n^e.charCodeAt(o++))&255];return~n},e.buf=function(e,t){for(var g=-1^t,E=e.length-15,C=0;C<E;)g=m[e[C++]^255&g]^y[e[C++]^g>>8&255]^v[e[C++]^g>>16&255]^p[e[C++]^g>>>24]^h[e[C++]]^d[e[C++]]^f[e[C++]]^u[e[C++]]^c[e[C++]]^l[e[C++]]^s[e[C++]]^a[e[C++]]^i[e[C++]]^o[e[C++]]^n[e[C++]]^r[e[C++]];for(E+=15;C<E;)g=g>>>8^r[(g^e[C++])&255];return~g},e.str=function(e,t){for(var n=-1^t,o=0,i=e.length,a=0,s=0;o<i;)(a=e.charCodeAt(o++))<128?n=n>>>8^r[(n^a)&255]:a<2048?n=(n=n>>>8^r[(n^(192|a>>6&31))&255])>>>8^r[(n^(128|63&a))&255]:a>=55296&&a<57344?(a=(1023&a)+64,s=1023&e.charCodeAt(o++),n=(n=(n=(n=n>>>8^r[(n^(240|a>>8&7))&255])>>>8^r[(n^(128|a>>2&63))&255])>>>8^r[(n^(128|s>>6&15|(3&a)<<4))&255])>>>8^r[(n^(128|63&s))&255]):n=(n=(n=n>>>8^r[(n^(224|a>>12&15))&255])>>>8^r[(n^(128|a>>6&63))&255])>>>8^r[(n^(128|63&a))&255];return~n}};if("undefined"==typeof DO_NOT_EXPORT_CRC)if("object"===o._(t))i(t);else if("function"==typeof define&&define.amd)e.r,i(n={}),void 0!==n&&e.v(n);else i({});else i({})},435575,e=>{"use strict";var r=e.i(716499),t=e.i(980768),n=e.i(529131);function o(e,o){(0,n.default)(2,arguments);var i=(0,r.default)(o);return(0,t.default)(e,1e3*i)}e.s(["addSeconds",()=>o],435575)},494065,e=>{"use strict";var r=e.i(968069),t=/^(\.npm$|\.npm\/|__pycache__|\.cache|\.breakpoints|\.git$|\.git\/|\.upm$|\.upm\/|node_modules$|node_modules\/|_test_runner|\.local)/;function n(e){return t.test(e)}function o(e){return e.startsWith(".")&&!r.default.includes(e)}var i=[".git",".upm",".cache","__pycache__","node_modules","venv",".pythonlibs",".local"];e.s(["ignoredDirs",()=>i,"isDotFile",()=>o,"isHiddenFile",()=>n])},880581,(e,r,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uniToStrPos=t.strPosToUni=void 0,t.strPosToUni=function(e){for(var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.length,t=0,n=0;n<r;n++){var o=e.charCodeAt(n);o>=55296&&o<=57343&&(t++,n++)}if(n!==r)throw Error("Invalid offset - splits unicode bytes");return n-t},t.uniToStrPos=function(e,r){for(var t=0;r>0;r--){var n=e.charCodeAt(t);t+=n>=55296&&n<=57343?2:1}return t}},118074,(e,r,t)=>{"use strict";var n=e.r(365738);Object.defineProperty(t,"__esModule",{value:!0});var o=e.r(880581),i=function(e){if(!Array.isArray(e))throw Error("Op must be an array of components");for(var r=null,t=0;t<e.length;t++){var o=e[t];switch(void 0===o?"undefined":n._(o)){case"object":if(!("number"==typeof o.d&&o.d>0))throw Error("Object components must be deletes of size > 0");break;case"string":if(!(o.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(o>0))throw Error("Skip components must be >0");if("number"==typeof r)throw Error("Adjacent skip components should be combined")}r=o}if("number"==typeof r)throw Error("Op has a trailing skip")},a=function(e){for(var r=[],t=s(r),n=0;n<e.length;n++)t(e[n]);return u(r)},s=function(e){return function(r){r&&0!==r.d&&(0===e.length?e.push(r):(void 0===r?"undefined":n._(r))===n._(e[e.length-1])?(void 0===r?"undefined":n._(r))==="object"?e[e.length-1].d+=r.d:e[e.length-1]+=r:e.push(r))}},l=function(e){return"number"==typeof e?e:"string"==typeof e?o.strPosToUni(e):e.d},c=function(e){var r=0,t=0;return{take:function(n,i){if(r===e.length)return -1===n?null:n;var a,s=e[r];if("number"==typeof s)if(-1===n||s-t<=n)return a=s-t,++r,t=0,a;else return t+=n,n;if("string"==typeof s)if(-1===n||"i"===i||o.strPosToUni(s.slice(t))<=n)return a=s.slice(t),++r,t=0,a;else{var l=t+o.uniToStrPos(s.slice(t),n);return a=s.slice(t,l),t=l,a}return -1===n||"d"===i||s.d-t<=n?(a={d:s.d-t},++r,t=0,a):(t+=n,{d:n})},peek:function(){return e[r]}}},u=function(e){return e.length>0&&"number"==typeof e[e.length-1]&&e.pop(),e};function f(e,r,t){if("left"!==t&&"right"!==t)throw Error("side ("+t+") must be 'left' or 'right'");i(e),i(r);for(var a,f=[],d=s(f),h=c(e),p=h.take,v=h.peek,y=0;y<r.length;y++){var m=r[y],g=void 0,E=void 0;switch(void 0===m?"undefined":n._(m)){case"number":for(g=m;g>0;)d(E=p(g,"i")),"string"!=typeof E&&(g-=l(E));break;case"string":"left"===t&&"string"==typeof v()&&d(p(-1)),d(o.strPosToUni(m));break;case"object":for(g=m.d;g>0;)switch(void 0===(E=p(g,"i"))?"undefined":n._(E)){case"number":g-=E;break;case"string":d(E);break;case"object":g-=E.d}}}for(;a=p(-1);)d(a);return u(f)}function d(e,r){i(e),i(r);for(var t,a=[],f=s(a),d=c(e).take,h=0;h<r.length;h++){var p=r[h],v=void 0,y=void 0;switch(void 0===p?"undefined":n._(p)){case"number":for(v=p;v>0;)f(y=d(v,"d")),(void 0===y?"undefined":n._(y))!=="object"&&(v-=l(y));break;case"string":f(p);break;case"object":for(v=p.d;v>0;)switch(void 0===(y=d(v,"d"))?"undefined":n._(y)){case"number":f({d:y}),v-=y;break;case"string":v-=o.strPosToUni(y);break;case"object":f(y)}}}for(;t=d(-1);)f(t);return u(a)}var h=function(e,r){for(var t=0,i=0;i<r.length&&e>t;i++){var a=r[i];switch(void 0===a?"undefined":n._(a)){case"number":t+=a;break;case"string":var s=o.strPosToUni(a);t+=s,e+=s;break;case"object":e-=Math.min(a.d,e-t)}}return e},p=function(e,r){return"number"==typeof e?h(e,r):e.map(function(e){return h(e,r)})};t.default=function(e){return{name:"text-unicode",uri:"http://sharejs.org/types/text-unicode",trim:u,normalize:a,checkOp:i,create:function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if("string"!=typeof r)throw Error("Initial data must be a string");return e.create(r)},apply:function(r,t){i(t);for(var o=e.builder(r),a=0;a<t.length;a++){var s=t[a];switch(void 0===s?"undefined":n._(s)){case"number":o.skip(s);break;case"string":o.append(s);break;case"object":o.del(s.d)}}return o.build()},transform:f,compose:d,transformPosition:h,transformSelection:p}}},753221,(e,r,t)=>{"use strict";var n=e.r(365738);Object.defineProperty(t,"__esModule",{value:!0});var o=e.r(880581);function i(e,r){return{get:e,getLength:function(){return e().length},insert:function(t,n,i){return r([o.strPosToUni(e(),t),n],i)},remove:function(t,n,i){return r([o.strPosToUni(e(),t),{d:n}],i)},_onOp:function(e){for(var r=0,t=0,o=0;o<e.length;o++){var i=e[o];switch(void 0===i?"undefined":n._(i)){case"number":r+=i,t+=i;break;case"string":this.onInsert&&this.onInsert(r,i),r+=i.length;break;case"object":this.onRemove&&this.onRemove(r,i.d),t+=i.d}}},onInsert:null,onRemove:null}}t.default=i,i.provides={text:!0}},402238,(e,r,t)=>{"use strict";var n=e.e&&e.e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.type=void 0;var o=e.r(880581),i=n(e.r(118074)),a=n(e.r(753221));t.type=Object.assign(Object.assign({},i.default({create:function(e){return e},toString:function(e){return e},builder:function(e){if("string"!=typeof e)throw Error("Invalid document snapshot: "+e);var r=[];return{skip:function(t){var n=o.uniToStrPos(e,t);if(n>e.length)throw Error("The op is too long for this document");r.push(e.slice(0,n)),e=e.slice(n)},append:function(e){r.push(e)},del:function(r){e=e.slice(o.uniToStrPos(e,r))},build:function(){return r.join("")+e}}}})),{api:a.default});var s=e.r(118074);Object.defineProperty(t,"makeType",{enumerable:!0,get:function(){return s.default}})},629712,798680,e=>{"use strict";e.i(33699);var r=e.i(297083),t=e.i(878420),n=e.i(64386),o=e.i(633600),i=e.i(346715),a=e.i(817556),s=e.i(906368),l=e.i(790155),c=e.i(960933),u=e.i(862927),f=e.i(469546),d=e.i(435575),h=e.i(753950),p=e.i(328751),v=e.i(626430),y=e.i(644920),m=e.i(968263),g=e.i(995683),E=e.i(193060),C=e.i(205104),F=e.i(353579),w=e.i(494065),_=e.i(240913),b=e.i(399119),T=e.i(904851),S=e.i(90659),k=e.i(721281),x=e.i(445789),D=e.i(152659),O=e.i(223808),R=e.i(402238),P=e.i(827444),I=e.i(709485),N=e.i(272391),A=e.i(119468);function M(e){return e.map(function(e){return(void 0===e?"undefined":(0,A._)(e))==="object"?{delete:e.d}:"number"==typeof e?{skip:e}:{insert:e}})}function L(e){return e.map(function(e){if("delete"in e&&e.delete)return{d:e.delete};if("skip"in e&&e.skip)return e.skip;if("insert"in e&&"string"==typeof e.insert)return e.insert;throw Error("Unexpected op type")})}function U(e,r){var t=[],n=r,o=0,i=0,a=0,s=0,l=function(e){var t=e-i;if(e<i)throw Error("expected changeset to be ordered");for(var n=i+a;n<i+t+a;n++){var o=r.charCodeAt(n);o>=55296&&o<=57343?(s++,n++):13===o&&10===r.charCodeAt(n+1)&&(a++,n++)}i+=t};return e.iterChanges(function(e,r,c,u,f){if(e>0){var d=i+a,h=d-s;l(e);var p=i+a,v=p-s;t.push(v-h),o+=p-d}if(e!==r){var y=i+a,m=y-s;l(r);var g=i+a,E=g-s;t.push({d:E-m}),n=n.slice(0,o)+n.slice(o+(g-y))}if(f.length){var C=f.sliceString(0);t.push(C),n=n.slice(0,o)+C+n.slice(o),o+=C.length}}),{op:t,docAfter:n}}function j(e,r){var t=[],n=r,o=0,i=0,a=0,s=0,l=function(e){for(var t=i+a;t<i+e+a;t++){var n=r.charCodeAt(t);n>=55296&&n<=57343?(a++,t++):13===n&&10===r.charCodeAt(t+1)&&(s++,t++)}i+=e},c=!0,u=!1,f=void 0;try{for(var d,p,v=e[Symbol.iterator]();!(c=(p=v.next()).done);c=!0){var y=p.value;if("string"==typeof y){var m=y;n=n.slice(0,o)+m+n.slice(o),o+=m.length;var g=i+a;if(m.endsWith("\r")&&"\n"===r.slice(g,g+1)&&(m=m.slice(0,-1),0===m.length))continue;var E=q(m),C=g-s;(null==d?void 0:d.to)===C?d.insert=d.insert?d.insert.append(E):E:(d={from:g-s,insert:E},t.push(d))}else if("number"==typeof y){var F=a;l(y);var w=a-F;o+=y+w}else if("d"in y){var _=i+a,b=s;l(y.d);var T=i+a,S=T-_;n=n.slice(0,o)+n.slice(o+S);var k=_-b,x=T-s;if("\r\n"===r.slice(_-1,_+1)&&(k+=1,(x-=1)-k<=0))continue;(null==d?void 0:d.to)===k?d.to=x:(d={from:k,to:x},t.push(d))}}}catch(e){u=!0,f=e}finally{try{c||null==v.return||v.return()}finally{if(u)throw f}}if(i+a!==r.length){var D=r.slice(i+a);s+=D.split("\r\n").length-1}return{changes:h.ChangeSet.of(t,r.length-s),docAfter:n}}var V=/\r\n?|\n/;function B(e){return e.replaceAll("\r\n","\n").replaceAll("\r","\n")}function q(e){return h.Text.of(e.split(V))}e.s(["asCodeMirrorText",()=>q,"changeSetToOp",()=>U,"fromProtocolOp",()=>L,"opToChangeSet",()=>j,"toCodeMirrorString",()=>B,"toProtocolOp",()=>M],798680);var z=e.i(569910),Q=e.i(903381);function W(e,r){var t=!0,n=!1,o=void 0;try{for(var i,a=r[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var s=i.value;switch(s){case Q.FsErrors.NotFound:if(e.includes("no such file")||e.includes("file does not exist"))return Q.FsErrors.NotFound;break;case Q.FsErrors.AlreadyExists:if(e.includes("file exist"))return Q.FsErrors.AlreadyExists;break;case Q.FsErrors.NotDirectory:if(e.includes("not a directory"))return Q.FsErrors.NotDirectory;break;case Q.FsErrors.IsDirectory:if(e.includes("is a directory"))return Q.FsErrors.IsDirectory;break;case Q.FsErrors.InvalidPath:if(e.includes("absolute paths are not supported"))return Q.FsErrors.InvalidPath;break;case Q.FsErrors.DiskQuotaExceeded:if(e.includes("disk quota exceeded"))return Q.FsErrors.DiskQuotaExceeded;break;case Q.FsErrors.PermissionDenied:if(e.includes("permission denied"))return Q.FsErrors.PermissionDenied;break;case Q.FsErrors.FileSystemUnavailable:if(e.includes("input/output error"))return Q.FsErrors.FileSystemUnavailable;break;case Q.FsErrors.NotReadable:if(e.includes("could not read the uploaded file"))return Q.FsErrors.NotReadable;break;default:(0,z.default)(s)}}}catch(e){n=!0,o=e}finally{try{t||null==a.return||a.return()}finally{if(n)throw o}}return null}var H=function(e){function o(e,i,s,l,c,u){(0,T._)(this,o),d=(0,b._)(this,o),(0,k._)(d,"linkedFile",void 0),(0,k._)(d,"channel",void 0),(0,k._)(d,"destroy",void 0),(0,k._)(d,"metadata",void 0),(0,k._)(d,"pending",void 0),(0,k._)(d,"inflight",void 0),(0,k._)(d,"inflightOpsPromise",void 0),(0,k._)(d,"version",void 0),(0,k._)(d,"serverContent",void 0),(0,k._)(d,"localContent",void 0),(0,k._)(d,"pendingCursors",void 0),(0,k._)(d,"flushedCursorIds",void 0),(0,k._)(d,"user",void 0),(0,k._)(d,"debounceSend",void 0),(0,k._)(d,"debounceCommit",void 0),(0,k._)(d,"commitPromise",void 0),(0,k._)(d,"isReconnecting",void 0),(0,k._)(d,"shouldTrackDataLoss",void 0),(0,k._)(d,"replId",void 0),(0,k._)(d,"uncommittedOps",void 0),(0,k._)(d,"hasUncommittedMultiplayerOps",void 0),(0,k._)(d,"committedVersion",void 0),(0,k._)(d,"committedContent",void 0),(0,k._)(d,"flushFailed",void 0),(0,k._)(d,"bufferedReconnectingOps",void 0),(0,k._)(d,"didEditOffline",void 0),(0,k._)(d,"reconnectTrackedData",void 0),(0,k._)(d,"timeDisconnected",void 0),(0,k._)(d,"logger",void 0),(0,k._)(d,"track",void 0),(0,k._)(d,"dataloss",void 0),(0,k._)(d,"writeChanges",function(e,r){if(!d.channel&&!d.isReconnecting)throw Error("Trying to send changes before ever coming online");d.isReconnecting&&(d.didEditOffline=!0);var n=U(e,d.localContent),o=n.op,i=n.docAfter;if(.1>Math.random()){var a=B(R.type.apply(d.localContent,o)),s=e.apply(q(d.localContent));(a!==s.sliceString(0)||a!==B(i))&&d.onError("changeset to op mismatch",{originalError:null,changes:e,otContent:a,changeSetContent:s,docAfter:i})}var l=(null==r?void 0:r.author)==="ghostwriter"?{author:v.api.OTPacket.Author.GHOSTWRITER}:{};d.metadata=(0,t._)({},d.metadata,l);try{d.pending=R.type.compose(d.pending,o)}catch(e){throw N.default.wrap(e).setExtras({op:o,pending:d.pending})}d.localContent=i,0!==d.pending.length?d.emit("fileDirty"):d.commitPromise&&d.emit("commitStart"),d.debounceSend()}),(0,k._)(d,"updateCursors",function(e){d.pendingCursors=e,d.debounceSend()}),(0,k._)(d,"isClean",function(){return d.committedVersion===d.version&&0===d.inflight.length&&0===d.pending.length}),(0,k._)(d,"onError",function(e,r){if(r.originalError){var o="string"==typeof r.originalError?r.originalError:r.originalError.message,i=W(o,[Q.FsErrors.NotFound,Q.FsErrors.IsDirectory,Q.FsErrors.DiskQuotaExceeded,Q.FsErrors.InvalidPath,Q.FsErrors.PermissionDenied,Q.FsErrors.FileSystemUnavailable]);if(i)return void d.emit("fsError",i,o)}d.destroy();var a=Error("OT Error: "+e);d.emit("error",a,(0,n._)((0,t._)({},r),{filePath:d.linkedFile,version:d.version}))}),(0,k._)(d,"sendOp",function(){if(d.channel&&"open"===d.channel.status&&!d.isReconnecting&&!(d.inflight.length>0)){if(0!==d.pending.length){var e=M(d.pending);d.inflight=d.pending,d.pending=[],d.inflightOpsPromise=d.channel.request({ot:(0,t._)({spookyVersion:d.version,op:e},d.metadata)}),d.metadata={},d.inflightOpsPromise.then(function(r){r.error&&d.onError("error accepting packet",{originalError:r.error,op:e})})}if(0!==d.pendingCursors.length){var r=!0,n=!1,o=void 0;try{for(var i,a=d.flushedCursorIds[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var s=i.value;d.channel.send({otDeleteCursor:{id:s}})}}catch(e){n=!0,o=e}finally{try{r||null==a.return||a.return()}finally{if(n)throw o}}d.flushedCursorIds=[];var l=!0,c=!1,u=void 0;try{for(var f,h=d.pendingCursors[Symbol.iterator]();!(l=(f=h.next()).done);l=!0){var p=f.value,v=Number(Math.random().toString().split(".")[1]).toString(36);d.flushedCursorIds.push(v),d.channel.send({otNewCursor:(0,t._)({id:v,user:d.user},p)})}}catch(e){c=!0,u=e}finally{try{l||null==h.return||h.return()}finally{if(c)throw u}}d.pendingCursors=[]}}}),(0,k._)(d,"handlePacket",function(e,r){var t,n,o,i=e.op,a=e.version,s=e.crc32,l=e.userId,c=r.overrideReconnectingBuffer;if(d.isReconnecting&&!c)return void d.bufferedReconnectingOps.push({crc32:s,op:i,version:a,userId:l});if(-1===d.version)return void d.onError("Got packet while version is still -1, expected version to be set in handleStatus",{originalError:null});if(d.version++,a!==d.version){var u={originalError:null,expectedVersion:d.version,receivedVersion:a,incomingOp:i};d.logger.error("OT Error: invalid server version",(0,P.flattenExtra)({details:u})),d.onError("invalid server version",u);return}try{d.serverContent=R.type.apply(d.serverContent,i)}catch(e){d.onError("unable to apply updated content",{originalError:e,incomingOp:i});return}var h=f.str(d.serverContent)>>>0;if(h!==s){var p={originalError:null,incomingVersion:a,server:s,client:h,incomingOp:i};d.logger.error("OT Error: crc32 mismatch",(0,P.flattenExtra)({details:p})),d.onError("crc32 mismatch",p);return}if(d.uncommittedOps.push({version:a,crc32:s,op:i,userId:l}),d.dataloss&&d.shouldTrackDataLoss&&d.dataloss.storeOp({replId:d.replId,filePath:d.linkedFile.toString(),opType:"latestOp",op:{version:a,crc32:s},logger:d.logger,isReconnecting:d.isReconnecting}),JSON.stringify(i)===JSON.stringify(d.inflight)){d.dataloss&&d.shouldTrackDataLoss&&d.dataloss.storeOp({replId:d.replId,filePath:d.linkedFile.toString(),opType:"latestOwnOp",op:{version:a,crc32:s},logger:d.logger,isReconnecting:d.isReconnecting}),d.debounceCommit(),d.inflight=[],d.inflightOpsPromise=null,d.debounceSend(),d.debounceSend.flush();return}if(d.commitPromise||d.emit("fileDirty"),d.debounceCommit(),d.hasUncommittedMultiplayerOps=!0,d.inflight.length){var v=R.type.transform(d.inflight,i,"right");i=R.type.transform(i,d.inflight,"left"),d.inflight=v}if(d.pending.length){var y=R.type.transform(d.pending,i,"right");i=R.type.transform(i,d.pending,"left"),d.pending=y}try{t=(o=j(i,d.localContent)).changes,n=o.docAfter}catch(e){d.onError("unable to apply updated op",{originalError:e,incomingOp:i});return}if(.1>Math.random()){var m=B(R.type.apply(d.localContent,i)),g=t.apply(q(d.localContent));(m!==g.sliceString(0)||m!==B(n))&&d.onError("op to changeset mismatch",{originalError:null,op:i,otContent:m,changeSetContent:g,docAfter:n})}d.localContent=n,d.emit("changes",t,l)}),(0,k._)(d,"handleNewCursor",function(e){d.emit("cursor",e)}),(0,k._)(d,"handleDeleteCursor",function(e){var r=e.id;d.emit("removeCursor",r)}),(0,k._)(d,"handleStatus",function(e){return(0,r._)(function(){var r,t,n,o,i;return(0,a._)(this,function(a){switch(a.label){case 0:if(!d.channel||"open"!==d.channel.status)return[2];if(e.linkedFile){if(null==e.contents)return d.onError("expected status contents, got null or undefined",{originalError:null}),[2];if(null==e.cursors)return d.onError("expected status cursors, got null or undefined",{originalError:null}),[2];if(null==e.version)return d.onError("expected status version, got null or undefined",{originalError:null}),[2];if(d.isReconnecting)return d.handleReconnect(e.contents,e.version),[2];return d.dataloss&&d.shouldTrackDataLoss&&d.dataloss.checkAndTrack({serverContent:e.contents,serverVersion:e.version,replId:d.replId,filePath:d.linkedFile.toString(),fetchOps:d.fetchOps,logger:d.logger}),d.serverContent=e.contents,d.localContent=d.serverContent,d.version=e.version,d.emit("firstConnect"),d.emit("changes",h.ChangeSet.of({from:0,insert:d.serverContent},0)),e.cursors.forEach(d.handleNewCursor),d.emit("fileDirty"),d.debounceCommit(),[2]}return[4,d.channel.request({otLinkFile:{file:{path:d.linkedFile.toString()}}})];case 1:if((t=a.sent()).channelClosed)return[2];if(t.error)return d.onError("link file error "+t.error.replace(d.linkedFile.toString(),"$FILENAME"),{originalError:t.error}),[2];if(!t.otLinkFileResponse)return d.onError("unexpected link file response: "+JSON.stringify(t.toJSON()),{originalError:null}),[2];if(n=t.otLinkFileResponse.version,i=g.default.from(null!=(o=null==(r=t.otLinkFileResponse.linkedFile)?void 0:r.content)?o:"").toString(),d.isReconnecting)return d.handleReconnect(i,n),[2];return d.dataloss&&d.shouldTrackDataLoss&&d.dataloss.checkAndTrack({serverContent:i,serverVersion:n,replId:d.replId,filePath:d.linkedFile.toString(),fetchOps:d.fetchOps,logger:d.logger}),d.serverContent=i,d.localContent=d.serverContent,d.version=n,d.committedVersion=n,d.committedContent=d.serverContent,d.emit("firstConnect"),d.emit("changes",h.ChangeSet.of({from:0,insert:d.serverContent},0)),[2]}})})()}),(0,k._)(d,"handleReconnect",function(e,o){return(0,r._)(function(){var r,i,s,l,c,u,f,h,p,v,y,m,g,E,C,F,w,_,b,T,S,k,x,D,O,N,A,M,L,U,j,V,B,q,z,Q,W,H,J,K,$,Y,Z,X,G,ee,er,et,en,eo,ei;return(0,a._)(this,function(a){switch(a.label){case 0:if(!d.timeDisconnected)throw Error("wat");if(r=Date.now()-d.timeDisconnected,i={case:"other",remoteContent:e,localContent:d.localContent},s=function(i){d.reconnectTrackedData=(0,n._)((0,t._)({},i),{serverVersion:o,ourVersion:d.version,ourCommittedVersion:d.committedVersion,areContentsEqual:d.serverContent===e,areCommittedContentsEqual:d.committedContent===e,didReceiveOpsWhileReconnecting:!!d.bufferedReconnectingOps.length,didEditOffline:d.didEditOffline,hasPendingOps:!!d.pending.length,hasUncommittedMultiplayerOps:d.hasUncommittedMultiplayerOps,disconnectDuration:r});var a={};("has_inflight"===i.case||"same_version_different_content"===i.case||"multiplayer"===i.case)&&.1>Math.random()&&(a={hasAdditionalLogs:!0,localContent:String(d.localContent),ourContent:String(d.serverContent),ourCommittedContent:String(d.committedContent),ourInflight:JSON.stringify(d.inflight),ourPending:JSON.stringify(d.pending),serverContent:String(e)}),d.logger.info("OT Client: Reconnect",(0,P.flattenExtra)((0,t._)({},d.reconnectTrackedData,a))),d.track&&d.track(I.events.FILE_RECONNECTED_STATUS2,d.reconnectTrackedData)},l=function(e,r){s({case:e,originCase:r,prompted:!1}),d.isReconnecting=!1,d.bufferedReconnectingOps=[],d.didEditOffline=!1,d.timeDisconnected=null,d.debounceSend(),d.debounceCommit(),d.emit("transparentReconnect",{case:e,originCase:r})},c=function(r){if(i.remoteContent===i.localContent){d.version=o,d.committedVersion=o,d.localContent=e,d.committedContent=e,d.serverContent=e,d.inflight=[],d.pending=[],l("unprompted_because_identical",r);return}s({case:r,prompted:!0}),i.case=r,d.emit("promptUserReconnect",i)},d.inflight.length){if(o===d.version&&d.serverContent===e)return d.pending=R.type.compose(d.inflight,d.pending),d.inflight=[],d.inflightOpsPromise=null,l("has_inflight_happy_path_ops_unreached"),[2];u=!1,f=d.serverContent;try{f=R.type.apply(f,d.inflight)}catch(e){u=!0}if(!u&&d.version+1===o&&f===e)return d.inflight=[],d.inflightOpsPromise=null,d.serverContent=e,d.version=o,l("has_inflight_happy_path_ops_reached"),[2];return c("has_inflight"),[2]}if(d.hasUncommittedMultiplayerOps)return c("multiplayer"),[2];if(d.version===o){if(e===d.serverContent)return l("happy_path"),[2];return c("same_version_different_content"),[2]}if(d.committedVersion===o){h=e;try{p=!0,v=!1,y=void 0;try{for(m=d.uncommittedOps[Symbol.iterator]();!(p=(g=m.next()).done);p=!0)E=g.value.op,h=R.type.apply(h,E)}catch(e){v=!0,y=e}finally{try{p||null==m.return||m.return()}finally{if(v)throw y}}}catch(e){return c("same_committed_version_unable_to_apply_ops"),[2]}if(h===d.serverContent){C=[],F=!0,w=!1,_=void 0;try{for(b=d.uncommittedOps[Symbol.iterator]();!(F=(T=b.next()).done);F=!0)S=T.value.op,C=R.type.compose(C,S)}catch(e){w=!0,_=e}finally{try{F||null==b.return||b.return()}finally{if(w)throw _}}return d.pending=R.type.compose(C,d.pending),d.uncommittedOps=[],d.version=o,d.serverContent=e,l("happy_path_uncommitted"),[2]}return c("same_committed_version_different_content_fixed"),[2]}if(!(d.version<o))return[3,3];return[4,d.fetchOps(d.version+1,o)];case 1:k=a.sent(),x=!1,D=d.serverContent;try{O=!0,N=!1,A=void 0;try{for(M=k[Symbol.iterator]();!(O=(L=M.next()).done);O=!0)U=L.value.op,D=R.type.apply(D,U)}catch(e){N=!0,A=e}finally{try{O||null==M.return||M.return()}finally{if(N)throw A}}}catch(e){x=!0}if(!x&&D===e){j=!0,V=!1,B=void 0;try{for(q=k[Symbol.iterator]();!(j=(z=q.next()).done);j=!0)Q=z.value,d.handlePacket(Q,{overrideReconnectingBuffer:!0})}catch(e){V=!0,B=e}finally{try{j||null==q.return||q.return()}finally{if(V)throw B}}W=!0,H=!1,J=void 0;try{for(K=d.bufferedReconnectingOps[Symbol.iterator]();!(W=($=K.next()).done);W=!0)Y=$.value,d.handlePacket(Y,{overrideReconnectingBuffer:!0})}catch(e){H=!0,J=e}finally{try{W||null==K.return||K.return()}finally{if(H)throw J}}return l("happy_path_server_ahead"),[2]}return[4,d.fetchOps(d.committedVersion+1,o)];case 2:Z=a.sent(),X=!1,G=d.committedContent;try{ee=!0,er=!1,et=void 0;try{for(en=Z[Symbol.iterator]();!(ee=(eo=en.next()).done);ee=!0)ei=eo.value.op,G=R.type.apply(G,ei)}catch(e){er=!0,et=e}finally{try{ee||null==en.return||en.return()}finally{if(er)throw et}}}catch(e){X=!0}if(!X&&G===e)return c("happy_path_uncommitted_server_ahead"),[2];return c("uncommitted_server_ahead"),[2];case 3:return c("other"),[2]}})})()}),(0,k._)(d,"flush",function(){return(0,r._)(function(){return(0,a._)(this,function(e){switch(e.label){case 0:return[4,d.commitPromise];case 1:return e.sent(),d.debounceCommit(),d.debounceCommit.flush(),[4,d.commitPromise];case 2:return e.sent(),[2]}})})()}),(0,k._)(d,"isFileSaved",function(){return!0}),(0,k._)(d,"fetchOps",function(e,t){return(0,r._)(function(){var r;return(0,a._)(this,function(n){switch(n.label){case 0:if(!d.channel)throw Error("No channel, cannot fetchOps");return[4,d.channel.request({otFetchRequest:{versionFrom:e,versionTo:t}})];case 1:if((r=n.sent()).channelClosed)throw Error("Channel closed while requesting");if(r.error)throw Error("Fetch ops returned an error: "+r.error);if(!r.otFetchResponse)throw Error("Expected otFetchResponse");if(!r.otFetchResponse.packets)throw Error("Expected otFetchResponse.packets");return[2,r.otFetchResponse.packets.map(function(e){var r=e.crc32,t=e.op,n=e.version,o=e.userId,i=e.committed,a=e.author;if(null==r)throw Error("Expected crc32 in packet");if(null==t)throw Error("Expected op in packet");if(null==n)throw Error("Expected version in packet");return{crc32:r,version:n,op:L(t),userId:o,timestamp:i?1e3*i.seconds:0,author:a}})]}})})()}),(0,k._)(d,"fetchChanges",function(e,t,n){return(0,r._)(function(){var r,o;return(0,a._)(this,function(i){switch(i.label){case 0:return[4,d.fetchOps(e,t)];case 1:return r=i.sent(),o=n,[2,r.map(function(e){var r=e.op,t=e.version,n=e.userId,i=e.timestamp,a=e.crc32,s=j(r,o),l=s.changes,c=s.docAfter,u=l.invert(q(o));return o=c,{changes:l,invertedChanges:u,userId:n,version:t,timestamp:i,crc32:a}})]}})})()}),(0,k._)(d,"transformSelection",function(e){var t=e.indexStart,n=e.indexEnd,o=e.versionFrom,i=e.versionTo;return(0,r._)(function(){var e,r,s,l;return(0,a._)(this,function(a){switch(a.label){case 0:if(!d.channel)throw Error("No channel, cannot transformSelection");return[4,d.channel.request({otTransformSelectionRequest:{indexStart:t,indexEnd:n,versionFrom:o,versionTo:i}})];case 1:if(!(e=a.sent()).otTransformSelectionResponse)throw Error("Expected otTransformSelectionResponse");return[2,{indexStart:null!=(r=e.otTransformSelectionResponse.indexStart)?r:0,indexEnd:null!=(s=e.otTransformSelectionResponse.indexEnd)?s:0,version:null!=(l=e.otTransformSelectionResponse.version)?l:0}]}})})()}),(0,k._)(d,"getLocalContent",function(){return B(d.localContent)}),(0,k._)(d,"getRawLocalContent",function(){return d.localContent}),d.shouldTrackDataLoss=!1,d.replId="",d.linkedFile=e,d.channel=null,d.inflight=[],d.inflightOpsPromise=null,d.uncommittedOps=[],d.hasUncommittedMultiplayerOps=!1,d.committedVersion=-1,d.isReconnecting=!1,d.bufferedReconnectingOps=[],d.didEditOffline=!1,d.pending=[],d.metadata={},d.version=-1,d.serverContent="",d.localContent="",d.committedContent="",d.flushedCursorIds=[],d.pendingCursors=[],d.user=null,d.flushFailed=0,d.debounceSend=(0,O.default)(function(){return d.sendOp()},20,{maxWait:60});var d,p=(0,O.default)(function(){return d.commitToDisk()},1e3,{maxWait:3e3}),y=function(){if(!d.channel)throw Error("Tryna commit while offline");if(d.isReconnecting)throw Error("Committing while reconnecting");return p()};y.cancel=p.cancel,y.flush=p.flush,d.debounceCommit=y,d.commitPromise=null,d.timeDisconnected=null;var m=!1;return d.destroy=function(){m=!0},d.logger=l,d.track=u,d.dataloss=c,s.then(function(){m||(d.destroy=i.openChannel({service:"ot",name:"ot:".concat(e)},function(r){var t=r.channel,n=r.context;return d.shouldTrackDataLoss=!window.navigator.userAgent.includes("Firefox"),d.replId=n.repl.id,d.dataloss&&d.shouldTrackDataLoss&&d.dataloss.ensureTrackedFile({replId:d.replId,filePath:e.toString()}),d.user=n.currentUser?{name:n.currentUser.username,id:n.currentUser.id}:null,d.channel=t,t.onCommand(function(e){switch(e.body){case"ot":if(!e.ot||null==e.ot.op||null==e.ot.spookyVersion||null==e.ot.crc32)return void d.onError("missing data in ot packet",{originalError:null,op:null==(r=e.ot)?void 0:r.op,spookyVersion:null==(t=e.ot)?void 0:t.spookyVersion,crc32:null==(n=e.ot)?void 0:n.crc32});if(-1===d.version)return;var r,t,n,o,i={crc32:e.ot.crc32,op:L(e.ot.op),version:e.ot.spookyVersion,userId:null!=(o=e.ot.userId)?o:0};return d.handlePacket(i,{overrideReconnectingBuffer:!1});case"otstatus":return d.handleStatus(e.otstatus);case"error":if(e.ref)return;return d.onError("Unknown protocol error OT channel",{originalError:e.error||"no error"});case"otNewCursor":return d.handleNewCursor(e.otNewCursor);case"otDeleteCursor":return d.handleDeleteCursor(e.otDeleteCursor)}}),function(){d.channel=null,d.isReconnecting=!0,d.debounceSend.cancel(),d.debounceCommit.cancel(),d.timeDisconnected||(d.timeDisconnected=Date.now())}}))}),d}return(0,x._)(o,e),(0,S._)(o,[{key:"commitToDisk",value:function(){return(0,r._)(function(){var e,r,t,n,o,i,s;return(0,a._)(this,function(a){switch(a.label){case 0:if(e=this,!this.channel)throw Error("Tryna commit while offline");if("open"!==this.channel.status)return[2];if(this.isReconnecting)throw Error("Committing while reconnecting");if(this.isClean())return[2];if(this.commitPromise)return this.debounceCommit(),[2];if(r=function(){},this.commitPromise=new Promise(function(e){return r=e}),!this.inflightOpsPromise)return[3,2];return[4,this.inflightOpsPromise];case 1:if(a.sent().channelClosed)return this.commitPromise=null,r(),[2];a.label=2;case 2:if(!(this.pending.length>0))return[3,4];if(this.debounceSend(),this.debounceSend.flush(),!this.inflightOpsPromise)return this.commitPromise=null,r(),this.onError("expected inflight promise",{originalError:null}),[2];return[4,this.inflightOpsPromise];case 3:if(a.sent().channelClosed)return this.commitPromise=null,r(),[2];a.label=4;case 4:return this.emit("commitStart"),t=this.version,n=this.serverContent,[4,this.channel.request({flush:{consistency:v.api.Flush.Consistency.Disk}})];case 5:if((o=a.sent()).channelClosed)return this.flushFailed=0,this.commitPromise=null,r(),[2];if("ok"!==o.body){if(this.commitPromise=null,r(),W(i=o.error||o.toString(),[Q.FsErrors.NotFound,Q.FsErrors.AlreadyExists,Q.FsErrors.NotDirectory,Q.FsErrors.IsDirectory,Q.FsErrors.DiskQuotaExceeded]))return this.onError("unable to flush",{originalError:i}),[2];return this.flushFailed++,setTimeout(function(){e.isReconnecting||e.channel&&"open"===e.channel.status&&e.debounceCommit()},Math.min(Math.random()*(Math.pow(2,this.flushFailed)-1)*1e3,1024e3)),[2]}return this.dataloss&&this.shouldTrackDataLoss&&(s=this.uncommittedOps[this.uncommittedOps.length-1])&&this.dataloss.storeOp({replId:this.replId,filePath:this.linkedFile.toString(),op:{crc32:s.crc32,version:s.version},opType:"latestFlushedOp",logger:this.logger,isReconnecting:this.isReconnecting}),this.uncommittedOps=[],this.hasUncommittedMultiplayerOps=!1,this.committedVersion=t,this.committedContent=n,this.flushFailed=0,this.emit("commitComplete",t),this.isClean()&&this.emit("fileClean"),this.commitPromise=null,r(),[2,o]}})}).call(this)}}]),o}(D.EventEmitter),J=e.i(837399);function K(e){var c,u=e.container,d=e.dataloss,F=e.track,b=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4,r=[];return{enqueue:function(t){for(var n=arguments.length,o=Array(n>1?n-1:0),a=1;a<n;a++)o[a-1]=arguments[a];if(r.length>=e)throw Error("fs: We retried too many things during a closed channel.");return new Promise(function(e){r.push(e)}).then(function(){return t.apply(void 0,(0,i._)(o))})},flush:function(){r.splice(0,r.length).forEach(function(e){return e()})}}}(),T=b.enqueue,S=b.flush,k=!1,x=null,D=null,O=null,R=0,P=new Map,I=new Map,N=new Map,A=[],M=new Map,L=new Set;u.openChannel({service:"fsevents"},function(e){var r=e.channel;x=r,r.onCommand(function(e){if("fileEvent"===e.body){if(!e.fileEvent)throw Error("Expected fileEvent");var r=e.fileEvent,t=r.file,n=r.dest,o=r.op;if(t){var i=t.path;if(null!==i&&null!==o&&void 0!==i&&void 0!==o){var a=(0,E.toRelativeFsPath)(i);if(J(),P.get(a)||t.type===v.api.File.Type.DIRECTORY)l=Q.FileType.Directory;else{var l,c,u=Array.from(P.keys()).find(function(e){return(0,E.isChildOf)(e,a)}),f=u&&(null==(c=P.get(u))?void 0:c.children.find(function(e){return e.filename===(0,E.getFsBaseName)(a)}));l=f?f.type:Q.FileType.File}switch(o){case v.api.FileEvent.Op.Create:X({eventType:Q.ChangeEventType.Create,node:{path:a,type:l}});break;case v.api.FileEvent.Op.Modify:if(l===Q.FileType.Directory){s.withScope(function(e){e.setTag("service","fs"),e.setExtra("path-str",i),e.setExtra("op",o),e.setExtra("file-type",l),s.captureException(Error("Unexpected modify directory event"))});break}X({eventType:Q.ChangeEventType.Modify,node:{path:a,type:l}});break;case v.api.FileEvent.Op.Remove:X({eventType:Q.ChangeEventType.Delete,node:{path:a,type:l}});break;case v.api.FileEvent.Op.Move:if(null==n||null==n.path)throw Error("Expected dest path");var d=n.path;X({eventType:Q.ChangeEventType.Move,node:{path:a,type:l},to:(0,E.toRelativeFsPath)(d)})}}}}});var t=(0,i._)(new Set((0,i._)(P.keys()).concat((0,i._)(I.keys()),(0,i._)(N.keys()))));return t.length&&r.send({subscribeFile:{files:t.map(function(e){return{path:e.toString()}})}}),function(){x=null}});var U=new Promise(function(e){return c=e});u.openChannel({service:function(e){return e.repl.authorizations.editFileContents.isAuthorized?"gcsfiles":"files"}},function(e){var r=e.channel;c(r),S();var t=(0,i._)(P.keys()).sort(),n=!0,o=!1,a=void 0;try{for(var s,l=t[Symbol.iterator]();!(n=(s=l.next()).done);n=!0)!function(){var e=s.value;et.readDir(e).then(function(r){var t=P.get(e);if(t){if(r.error)return void X({eventType:Q.ChangeEventType.Delete,node:{path:e,type:Q.FileType.Directory}});var n=r.children,o=t.children,i=o.filter(function(e){return!n.some(function(r){return r.filename===e.filename&&r.type===e.type})}),a=!0,s=!1,l=void 0;try{for(var c,u=i[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){var f=c.value;X({eventType:Q.ChangeEventType.Delete,node:{path:(0,E.joinFsPath)(e,f.filename),type:f.type}})}}catch(e){s=!0,l=e}finally{try{a||null==u.return||u.return()}finally{if(s)throw l}}var d=n.filter(function(e){return!o.some(function(r){return r.filename===e.filename&&r.type===e.type})}),h=!0,p=!1,v=void 0;try{for(var y,m=d[Symbol.iterator]();!(h=(y=m.next()).done);h=!0){var g=y.value;X({eventType:Q.ChangeEventType.Create,node:{path:(0,E.joinFsPath)(e,g.filename),type:g.type}})}}catch(e){p=!0,v=e}finally{try{h||null==m.return||m.return()}finally{if(p)throw v}}}})}()}catch(e){o=!0,a=e}finally{try{n||null==l.return||l.return()}finally{if(o)throw a}}var u=!0,f=!1,d=void 0;try{for(var h,p=N.keys()[Symbol.iterator]();!(u=(h=p.next()).done);u=!0)!function(){var e=h.value;et.readFile(e,{fromDisk:!0}).then(function(r){var t=N.get(e);!t||(r.error?X({eventType:Q.ChangeEventType.Delete,node:{path:e,type:Q.FileType.File}}):r.content.toBuffer().equals(t.latestContent.toBuffer())||X({eventType:Q.ChangeEventType.Modify,node:{path:e,type:Q.FileType.File}}))})}()}catch(e){f=!0,d=e}finally{try{u||null==p.return||p.return()}finally{if(f)throw d}}return function(){U=new Promise(function(e){return c=e})}});var j=(0,m.default)();j.promise.catch(function(e){return e});var V=(0,y.default)(function(){return(0,r._)(function(){var e;return(0,a._)(this,function(r){switch(r.label){case 0:return[4,j.promise];case 1:return[4,r.sent().request({fsSnapshot:{}})];case 2:if((e=r.sent()).channelClosed)return[2,{success:!1,error:"channel closed"}];if(e.error)return[2,{success:!1,error:e.error}];return[2,{error:null,success:!0}]}})})()},{wait:5e3,maxWait:1e4});u.openChannel({service:"snapshot",skip:function(e){return!e.repl.authorizations.editFileContents.isAuthorized}},function(e){var r=e.channel;return j.resolve(r),function(){j.isFulfilled&&(j=(0,m.default)()).promise.catch(function(e){return e})}});var B=Q.FsStatus.Clean,q=[],z=0;function J(){return(0,r._)(function(){var e;return(0,a._)(this,function(r){switch(r.label){case 0:return z++,K(),[4,et.persist()];case 1:return(e=r.sent()).error&&l.logger.error("Failed to persist, something very bad has probably happened",{originalError:e.error}),z--,K(),[2]}})})()}function K(){return(0,r._)(function(){var e;return(0,a._)(this,function(r){return(e=0===z&&0===$.length&&Array.from(I.values()).every(function(e){return e.otClient.isClean()}))===(B===Q.FsStatus.Clean)||(B=e?Q.FsStatus.Clean:Q.FsStatus.Syncing,q.forEach(function(e){e(B,{hasUserChanged:k})})),[2]})})()}var $=[];function Y(e){k=!0,$.push(e),K(),e.then(function(){var r=$.indexOf(e);r>-1&&$.splice(r,1),J()})}function Z(e,t){return(0,r._)(function(){var n,o;return(0,a._)(this,function(i){return o=(n=function(){return(0,r._)(function(){var r,t,o;return(0,a._)(this,function(i){switch(i.label){case 0:return[4,U];case 1:if("open"!==(r=i.sent()).status)return[2,T(n)];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,r.request(e)];case 3:return t=i.sent(),[3,5];case 4:return o=i.sent(),s.captureException(Error("Send request failed with error: ".concat(o))),[2,T(n)];case 5:if(t.channelClosed)return[2,T(n)];return[2,t]}})})()})(),t.isMutative&&Y(o),[2,o]})})()}function X(e){O=null;var r=(0,E.getParentFsPath)(e.node.path),o=P.get(r),a=(0,E.getFsBaseName)(e.node.path);if(!a)throw Error("Expected filename");var l=null;if(e.eventType===Q.ChangeEventType.Move){var c=(0,E.getParentFsPath)(e.to);l=P.get(c)}if(o||l)switch(e.eventType){case Q.ChangeEventType.Create:if(!o)break;var u=(0,i._)(o.children.filter(function(e){return e.filename!==a})).concat([{type:e.node.type,filename:a}]),f=!0,d=!1,h=void 0;try{for(var p,v=o.listeners[Symbol.iterator]();!(f=(p=v.next()).done);f=!0)(0,p.value.onChange)(u)}catch(e){d=!0,h=e}finally{try{f||null==v.return||v.return()}finally{if(d)throw h}}o.children=u;break;case Q.ChangeEventType.Move:var y=(0,E.getFsBaseName)(e.to);if(o&&o===l){var m=(0,i._)(o.children.filter(function(e){return e.filename!==a&&e.filename!==y})).concat([{type:e.node.type,filename:y}]),g=!0,C=!1,F=void 0;try{for(var w,_=o.listeners[Symbol.iterator]();!(g=(w=_.next()).done);g=!0)(0,w.value.onChange)(m)}catch(e){C=!0,F=e}finally{try{g||null==_.return||_.return()}finally{if(C)throw F}}o.children=m;break}if(o){var b=o.children.filter(function(e){return e.filename!==a}),T=!0,S=!1,k=void 0;try{for(var x,D=o.listeners[Symbol.iterator]();!(T=(x=D.next()).done);T=!0)(0,x.value.onChange)(b)}catch(e){S=!0,k=e}finally{try{T||null==D.return||D.return()}finally{if(S)throw k}}o.children=b}if(l){var R=(0,i._)(l.children.filter(function(e){return e.filename!==a&&e.filename!==y})).concat([{type:e.node.type,filename:y}]),A=!0,M=!1,L=void 0;try{for(var U,j=l.listeners[Symbol.iterator]();!(A=(U=j.next()).done);A=!0)(0,U.value.onChange)(R)}catch(e){M=!0,L=e}finally{try{A||null==j.return||j.return()}finally{if(M)throw L}}l.children=R}break;case Q.ChangeEventType.Delete:if(!o)break;var V=o.children.filter(function(e){return e.filename!==a}),B=!0,q=!1,z=void 0;try{for(var W,H=o.listeners[Symbol.iterator]();!(B=(W=H.next()).done);B=!0)(0,W.value.onChange)(V)}catch(e){q=!0,z=e}finally{try{B||null==H.return||H.return()}finally{if(q)throw z}}o.children=V;break;case Q.ChangeEventType.Modify:break;default:throw Error("unknown event")}switch(e.eventType){case Q.ChangeEventType.Move:case Q.ChangeEventType.Delete:var J=[I.get(e.node.path),N.get(e.node.path),P.get(e.node.path)],K=!0,$=!1,Y=void 0;try{for(var Z,G=J[Symbol.iterator]();!(K=(Z=G.next()).done);K=!0){var ee=Z.value;if(ee){var er=!0,en=!1,eo=void 0;try{for(var ei,ea=ee.listeners[Symbol.iterator]();!(er=(ei=ea.next()).done);er=!0){var es=ei.value,el=es.onMoveOrDelete,ec=es.dispose;el&&el(e),ec()}}catch(e){en=!0,eo=e}finally{try{er||null==ea.return||ea.return()}finally{if(en)throw eo}}}}}catch(e){$=!0,Y=e}finally{try{K||null==G.return||G.return()}finally{if($)throw Y}}if(e.node.type===Q.FileType.File)break;var eu=(0,i._)(new Set((0,i._)(P.keys()).concat((0,i._)(N.keys()),(0,i._)(I.keys())))).map(function(e){var r=I.get(e)||N.get(e)||P.get(e);if(!r)throw Error("expected node");return r}),ef=[],ed=!0,eh=!1,ep=void 0;try{for(var ev,ey=eu.sort()[Symbol.iterator]();!(ed=(ev=ey.next()).done);ed=!0){var em=ev.value;if((0,E.isDescendantOf)(e.node.path,em.path)){var eg=ef.slice(-1)[0];if(!(eg&&(0,E.isDescendantOf)(eg,em.path))){var eE={eventType:Q.ChangeEventType.Delete,node:{path:em.path,type:em.type}};e.eventType===Q.ChangeEventType.Move&&(eE=(0,n._)((0,t._)({},eE),{eventType:Q.ChangeEventType.Move,to:(0,E.moveDescendantFsPath)(e.node.path,e.to,em.path)})),ef.push(em.path),X(eE)}}}}catch(e){eh=!0,ep=e}finally{try{ed||null==ey.return||ey.return()}finally{if(eh)throw ep}}break;case Q.ChangeEventType.Create:case Q.ChangeEventType.Modify:if(!N.has(e.node.path))break;et.readFile(e.node.path,{fromDisk:!0}).then(function(r){var t=N.get(e.node.path);if(t){if(r.error)return void X({eventType:Q.ChangeEventType.Delete,node:{path:e.node.path,type:Q.FileType.File}});t.latestContent=r.content;var n=!0,o=!1,i=void 0;try{for(var a,s=t.listeners[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value.onChange;l&&l(r.content)}}catch(e){o=!0,i=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw i}}}}).catch(function(e){e.message="File read after modify error: "+e.message,s.captureException(e)})}}function G(e){var r=!0,t=!1,n=void 0;try{for(var o,i=A[Symbol.iterator]();!(r=(o=i.next()).done);r=!0)(0,o.value)(e)}catch(e){t=!0,n=e}finally{try{r||null==i.return||i.return()}finally{if(t)throw n}}}var ee=function(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return(0,r._)(function(){var i,s,l,c,u,d,h,p,v,y,m,g;function E(e){return(0,r._)(function(){var r;return(0,a._)(this,function(t){switch(t.label){case 0:return[4,i.request(e)];case 1:if((r=t.sent()).channelClosed)throw Error("channelClosed");if(r.error)throw Error(r.error);return[2,r]}})})()}return(0,a._)(this,function(r){switch(r.label){case 0:if(!o&&e===_.DOT_ENV)return[2,{error:Q.FsErrors.InvalidPath}];return[4,U];case 1:i=r.sent(),s={eventType:Q.ChangeEventType.Create,node:{path:e,type:Q.FileType.File}},r.label=2;case 2:return r.trys.push([2,12,,13]),l=t.size,[4,E({transferStart:{path:e.toString(),size:l}})];case 3:if(!(c=r.sent().transfer))throw Error("Failed to start a transfer (no transfer id)");u=524288,n(l,0),d=0,h=0,p=void 0,v=void 0,r.label=4;case 4:if(!(d<l))return[3,10];r.label=5;case 5:return r.trys.push([5,7,,8]),[4,(p=t.slice(d,d+u)).arrayBuffer()];case 6:return v=r.sent(),[3,8];case 7:throw r.sent(),new Q.FileReadError;case 8:return y=new Uint8Array(v),[4,E({transferChunk:{id:c.id,content:y}})];case 9:return r.sent(),h=f.buf(y,h),d+=p.size,n(l,d),[3,4];case 10:return[4,E({transferComplete:{id:c.id,crc32:h}})];case 11:return r.sent(),[3,13];case 12:if("channelClosed"===(m=r.sent()).message)return[2,T(et.transferFile,e,t,n)];if((g=W(m.message,[Q.FsErrors.NotDirectory,Q.FsErrors.AlreadyExists,Q.FsErrors.DiskQuotaExceeded,Q.FsErrors.NotReadable]))===Q.FsErrors.DiskQuotaExceeded&&G(s),g===Q.FsErrors.AlreadyExists&&(g=Q.FsErrors.IsDirectory),g)return[2,{error:g}];throw m;case 13:return X(s),[2,{error:null}]}})})()};function er(e){var r=new H(e,u,Promise.all((0,i._)($).map(function(e){return e.catch(function(){})})).then(function(){}),u.logger,d,F);return r.on("commitComplete",J),r.on("fileDirty",K),r.on("fileClean",K),r.on("commitStart",K),r}var et={getStatus:function(){return B},onStatusChange:function(e){return q.push(e),function(){var r=q.indexOf(e);r>-1&&q.splice(r,1)}},watchDir:function(e,r){var o=!1,i=function(){o=!0;var r=P.get(e);r&&(r.listeners=r.listeners.filter(function(e){return e.dispose!==i}),0===r.listeners.length&&P.delete(e))};return et.readDir(e).then(function(a){if(!o){if(a.error){var s=Error(a.error);s.code=a.error,r.onError(s),i();return}var l=P.get(e);!l&&(l={path:e,type:Q.FileType.Directory,children:a.children,listeners:[]},P.set(e,l),x&&x.send({subscribeFile:{files:[{path:e.toString()}]}})),l.listeners.push((0,n._)((0,t._)({},r),{dispose:i})),r.onChange(a.children)}}).catch(function(e){i(),r.onError(e)}),i},watchPathStat:function(e,r){var t=0,n=!1,i=function(a,s,l){if(s===Q.FileType.File)return function(){};var c=(0,o._)(l),u=c[0],f=c.slice(1),d=u===e;if(d&&0!==f.length)throw Error("Invariant: child is target but has more children");var h=null,p=et.watchDir(a,{onChange:function(o){var a=o.find(function(e){return e.filename===(0,E.getFsBaseName)(u)});if(!a){n||(r.onNewStat({exists:!1}),n=!0),h&&(h.dispose(),h=null);return}if(h&&a.type!==h.node.type&&(h.dispose(),h=null),!h){if(d){var s=++t;et.stat(e).then(function(e){s!==t||e.exists&&(r.onNewStat(e),n=!1,h={node:a,dispose:function(){}})});return}h={node:a,dispose:i(u,a.type,f)}}},onError:r.onError});return function(){null==h||h.dispose(),p()}},a=(0,o._)((0,E.splitFsPaths)(e)),s=a[0],l=a.slice(1);return i(s,Q.FileType.Directory,l)},watchFilePath:function(e,r){var t,n=function(e,t){if(0===t.length){var o=et.watchFile((0,E.toRelativeFsPath)(e),r);return function(){o()}}var i,a=t[0],s=!1,l=et.watchDir((0,E.toRelativeFsPath)(e),{onChange:function(r){var o=r.find(function(e){return e.filename.toString()===a});if(!s&&o){i=n("".concat(e,"/").concat(a),t.slice(1)),s=!0;return}s=!1},onMoveOrDelete:function(){null==i||i()},onError:function(){}});return function(){null==i||i(),l()}},o=e.toString().split("/"),i=!1,a=et.watchDir((0,E.toRelativeFsPath)(""),{onChange:function(e){var r=e.find(function(e){return e.filename.toString()===o[0]});if(!i&&r){t=n(o[0],o.slice(1)),i=!0;return}i=!1},onError:function(){}});return function(){null==t||t(),a()}},writeFile:function(e,t){return(0,r._)(function(){var r,n,o,i,s,l;return(0,a._)(this,function(a){switch(a.label){case 0:return n="string"==typeof t?g.default.from(t).toBuffer():t.toBuffer(),[4,Z({write:{path:e.toString(),content:n}},{isMutative:!0})];case 1:if(o=a.sent(),s=null==(r=P.get((0,E.getParentFsPath)(e)))?void 0:r.children.some(function(r){return r.filename===(0,E.getFsBaseName)(e)}),i=N.has(e)||I.has(e)||s?{eventType:Q.ChangeEventType.Modify,node:{path:e,type:Q.FileType.File}}:{eventType:Q.ChangeEventType.Create,node:{path:e,type:Q.FileType.File}},o.error){if((l=W(o.error,[Q.FsErrors.NotDirectory,Q.FsErrors.AlreadyExists,Q.FsErrors.DiskQuotaExceeded]))===Q.FsErrors.DiskQuotaExceeded&&G(i),l===Q.FsErrors.AlreadyExists&&(l=Q.FsErrors.IsDirectory),!l)throw Error(o.error);return[2,{error:l}]}return X(i),[2,{error:null}]}})})()},transferFile:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,r._)(function(){var e;return(0,a._)(this,function(r){return Y(e=ee.apply(void 0,(0,i._)(t))),[2,e]})})()},readFile:function(e){return(0,r._)(function(e){var r,t,n,o=arguments;return(0,a._)(this,function(i){switch(i.label){case 0:if(!(o.length>1&&void 0!==o[1]?o[1]:{fromDisk:!1}).fromDisk&&(r=I.get(e))&&r.otClient.getRawLocalContent()&&!r.otClient.isReconnecting)return[2,{content:g.default.from(r.otClient.getRawLocalContent()),error:null}];return[4,Z({read:{path:e.toString()}},{isMutative:!1})];case 1:if((t=i.sent()).error){if(!(n=W(t.error,[Q.FsErrors.NotFound,Q.FsErrors.IsDirectory])))throw Error(t.error);return[2,{error:n}]}if(!t.file||!t.file.path||!t.file.content)throw Error("Expected file");return[2,{content:g.default.from(t.file.content),error:null}]}})}).apply(this,arguments)},createDir:function(e){return(0,r._)(function(){var r,t,n;return(0,a._)(this,function(o){switch(o.label){case 0:return[4,Z({mkdir:{path:e.toString()}},{isMutative:!0})];case 1:if(r=o.sent(),t={eventType:Q.ChangeEventType.Create,node:{path:e,type:Q.FileType.Directory}},r.error){if((n=W(r.error,[Q.FsErrors.NotDirectory,Q.FsErrors.DiskQuotaExceeded]))===Q.FsErrors.DiskQuotaExceeded&&G(t),!n)throw Error(r.error);return[2,{error:n}]}return X(t),[2,{error:null}]}})})()},moveDir:function(e,t){return(0,r._)(function(){var r,n,o;return(0,a._)(this,function(i){switch(i.label){case 0:return[4,Z({move:{oldPath:e.toString(),newPath:t.toString()}},{isMutative:!0})];case 1:if(r=i.sent(),n={eventType:Q.ChangeEventType.Move,node:{path:e,type:Q.FileType.Directory},to:t},r.error){if((o=W(r.error,[Q.FsErrors.NotFound,Q.FsErrors.AlreadyExists,Q.FsErrors.NotDirectory,Q.FsErrors.DiskQuotaExceeded]))===Q.FsErrors.DiskQuotaExceeded&&G(n),!o)throw Error(r.error);return[2,{error:o}]}return X(n),[2,{error:null}]}})})()},moveFile:function(e,t){return(0,r._)(function(){var r,n,o;return(0,a._)(this,function(i){switch(i.label){case 0:return[4,Z({move:{oldPath:e.toString(),newPath:t.toString()}},{isMutative:!0})];case 1:if(r=i.sent(),n={eventType:Q.ChangeEventType.Move,node:{path:e,type:Q.FileType.File},to:t},r.error){if((o=W(r.error,[Q.FsErrors.NotFound,Q.FsErrors.AlreadyExists,Q.FsErrors.NotDirectory,Q.FsErrors.DiskQuotaExceeded]))===Q.FsErrors.DiskQuotaExceeded&&G(n),!o)throw Error(r.error);return[2,{error:o}]}return X(n),[2,{error:null}]}})})()},copyFile:function(e,t){return(0,r._)(function(){var r;return(0,a._)(this,function(n){switch(n.label){case 0:return[4,et.readFile(e)];case 1:if((r=n.sent()).error)return[2,r];return[2,et.writeFile(t,r.content)]}})})()},copyDirFromRemote:function(e,t,n){return(0,r._)(function(){var r,o,i,s,l,c,u,f,d,h,p,v,y;return(0,a._)(this,function(a){switch(a.label){case 0:return[4,this.deleteDir(e)];case 1:return a.sent(),[4,n.readDir(e)];case 2:if((r=a.sent()).error)return[2,r];return[4,this.readDir(t)];case 3:if((o=a.sent()).error!==Q.FsErrors.NotFound)return[3,5];return[4,this.createDir(e)];case 4:return a.sent(),[3,6];case 5:if(o.error===Q.FsErrors.NotDirectory)return[2,o];a.label=6;case 6:i=!0,s=!1,l=void 0,a.label=7;case 7:a.trys.push([7,15,16,17]),c=r.children[Symbol.iterator](),a.label=8;case 8:if(i=(u=c.next()).done)return[3,14];if(f=u.value,d=(0,E.joinFsPath)(e,f.filename),f.type!==Q.FileType.File)return[3,11];return[4,n.readFile(d)];case 9:if((h=a.sent()).error)return[2,h];return[4,this.writeFile((0,E.joinFsPath)(t,f.filename),h.content)];case 10:if((p=a.sent()).error)return[2,p];return[3,13];case 11:if(f.type!==Q.FileType.Directory)return[3,13];return[4,this.copyDirFromRemote(d,(0,E.joinFsPath)(t,f.filename),n)];case 12:if((v=a.sent()).error)return[2,v];a.label=13;case 13:return i=!0,[3,8];case 14:return[3,17];case 15:return y=a.sent(),s=!0,l=y,[3,17];case 16:try{i||null==c.return||c.return()}finally{if(s)throw l}return[7];case 17:return[2,{error:null}]}})}).call(this)},copyFileFromRemote:function(e,t,n){return(0,r._)(function(){var r,o;return(0,a._)(this,function(i){switch(i.label){case 0:return[4,n.readFile(e)];case 1:if((r=i.sent()).error)return[2,r];return[4,this.writeFile(t,r.content)];case 2:if((o=i.sent()).error)return[2,o];return[2,{error:null}]}})}).call(this)},deleteFile:function(e){return(0,r._)(function(){var r,t;return(0,a._)(this,function(n){switch(n.label){case 0:return[4,Z({remove:{path:e.toString()}},{isMutative:!0})];case 1:if((r=n.sent()).error){if(!(t=W(r.error,[Q.FsErrors.NotFound])))throw Error(r.error);return[2,{error:t}]}return X({eventType:Q.ChangeEventType.Delete,node:{path:e,type:Q.FileType.File}}),[2,{error:null}]}})})()},deleteDir:function(e){return(0,r._)(function(){var r,t;return(0,a._)(this,function(n){switch(n.label){case 0:return[4,Z({remove:{path:e.toString()}},{isMutative:!0})];case 1:if((r=n.sent()).error){if(!(t=W(r.error,[Q.FsErrors.NotFound])))throw Error(r.error);return[2,{error:t}]}return X({eventType:Q.ChangeEventType.Delete,node:{path:e,type:Q.FileType.Directory}}),[2,{error:null}]}})})()},readDir:function(e){return(0,r._)(function(){var r,t,n;return(0,a._)(this,function(o){switch(o.label){case 0:return[4,Z({readdir:{path:e.toString()}},{isMutative:!1})];case 1:if((t=o.sent()).error){if(!(n=W(t.error,[Q.FsErrors.NotFound,Q.FsErrors.NotDirectory,Q.FsErrors.FileSystemUnavailable])))throw Error(t.error);return[2,{error:n}]}if(!(null==(r=t.files)?void 0:r.files))throw Error("Expected filesChannel");return[2,{children:t.files.files.map(function(e){if(!e.path)throw Error("Expected path");return{filename:(0,E.getFsBaseName)((0,E.toRelativeFsPath)(e.path)),type:e.type===v.api.File.Type.DIRECTORY?Q.FileType.Directory:Q.FileType.File}}),error:null}]}})})()},stat:function(e){return(0,r._)(function(){var r;return(0,a._)(this,function(t){switch(t.label){case 0:return[4,Z({stat:{path:e.toString()}},{isMutative:!1})];case 1:if((r=t.sent()).error)throw Error(r.error);if(!r.statRes)throw Error("expected stat result");if(!r.statRes.exists)return[2,{exists:!1}];if(r.statRes.type===v.api.File.Type.DIRECTORY)return[2,{exists:!0,type:Q.FileType.Directory,lastModified:new Date(1e3*r.statRes.modTime)}];return[2,{exists:!0,type:Q.FileType.File,lastModified:new Date(1e3*r.statRes.modTime),byteLength:Number(r.statRes.size)}]}})})()},watchTextFile:function(e,o){var s=this;if(!(0,E.isAbsolutePath)(e)&&(0,E.isRoot)((0,E.toRelativeFsPath)(e)))throw Error("Cannot watch root directory");var l=I.get(e);if(l||(l={path:e,type:Q.FileType.File,listeners:[],otClient:er(e)},I.set(e,l)),!l)throw Error("Expected watchedOtFile");var c=!1,u=!1,f=function(){},d=[],v=function(t){if(f(),!l)throw Error("Expected watchedOtFile");var n,m=function(e){var r;return null==(r=o.onFlush)?void 0:r.call(o,e)};l.otClient.on("commitComplete",m);var g=function(){var e;return null==(e=o.onStatusChange)?void 0:e.call(o,Q.FileStatus.Dirty)};l.otClient.on("fileDirty",g);var E=function(){var e;return null==(e=o.onStatusChange)?void 0:e.call(o,Q.FileStatus.Clean)};l.otClient.on("fileClean",E);var C=function(){var e;return null==(e=o.onStatusChange)?void 0:e.call(o,Q.FileStatus.Syncing)};l.otClient.on("commitStart",C);var F=function(e){var r;return null==(r=o.onCursor)?void 0:r.call(o,e)};l.otClient.on("cursor",F);var w=function(e){var r;return null==(r=o.onRemoveCursor)?void 0:r.call(o,e)};l.otClient.on("removeCursor",w);var _=function(e){var r;return null==(r=o.onFileSavedChanged)?void 0:r.call(o,e)};l.otClient.on("fileSavedChanged",_);var b=function(t){return(0,r._)(function(){var r,n,o,i,s,c,u,f,h,v,y,m;return(0,a._)(this,function(a){switch(a.label){case 0:if(!l)throw Error("Expected watchedOtFile");return(r=l.otClient).destroy(),n=er(e),[4,new Promise(function(e,r){n.once("changes",function(){return e()}),n.once("error",function(e){return r(e)})})];case 1:if(a.sent(),o=r.getLocalContent(),i=n.getLocalContent(),s="local"===t?(0,p.changeSetFromDiff)(i,o):null,c="remote"===t?(0,p.changeSetFromDiff)(o,i):null,!l)throw Error("Expected watchedOtFile");l.otClient=n,u=!0,f=!1,h=void 0;try{for(v=l.listeners[Symbol.iterator]();!(u=(y=v.next()).done);u=!0)(0,y.value.reregister)(c)}catch(e){f=!0,h=e}finally{try{u||null==v.return||v.return()}finally{if(f)throw h}}for(s&&n.writeChanges(s);d.length>0;)null==(m=d.pop())||m({isDisposed:!1});return[4,this.flush()];case 2:return a.sent(),[2]}})}).call(s)},T=function(e){var r;return null==(r=o.onReconnectFail)?void 0:r.call(o,b,e)};l.otClient.on("promptUserReconnect",T),l.listeners[0].reregister===v&&l.otClient.on("promptUserReconnect",function(){if(I.has(e)){if(!l)throw Error("Expected watchedOtFile");l.listeners.some(function(e){return e.onReconnectFail})||b("remote")}});var S=function(e,r){o.onError&&o.onError(e,r),y()};l.otClient.on("error",S);var x=function(r,t){if(r===Q.FsErrors.DiskQuotaExceeded&&G({eventType:Q.ChangeEventType.Modify,node:{path:e,type:Q.FileType.File}}),o.onError){var n=Error(t);n.code=r,o.onError(n)}y()};l.otClient.on("fsError",x);var D=function(e,r){if(!l)throw Error("Expected watchedOtFile");k=!0;var t=h.ChangeSet.of(e,l.otClient.getLocalContent().length,"\n");l.otClient.writeChanges(t,r);var n=!0,i=!1,a=void 0;try{for(var s,c=l.listeners[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var u=s.value.onChange;u&&u!==o.onChange&&u({changes:t,changeSource:Q.ChangeSource.Local,version:l.otClient.version,latestContent:l.otClient.getLocalContent()})}}catch(e){i=!0,a=e}finally{try{n||null==c.return||c.return()}finally{if(i)throw a}}},O=function(){return(0,r._)(function(){return(0,a._)(this,function(e){return(null==l?void 0:l.otClient.isReconnecting)?[2,new Promise(function(e,r){l?d.push(e):r(Error("Expected watchedOtFile"))})]:[2,{isDisposed:c}]})})()},R=function(){for(;d.length>0;){var e;null==(e=d.pop())||e({isDisposed:!1})}};l.otClient.on("transparentReconnect",R);var P=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,r._)(function(){var e,r;return(0,a._)(this,function(n){switch(n.label){case 0:if(!l)throw Error("Expected watchedOtFile");n.label=1;case 1:return n.trys.push([1,3,,4]),[4,O()];case 2:if(n.sent().isDisposed)return[2,{isDisposed:!0,result:null}];return[3,4];case 3:if(r=n.sent(),c)return[2,{isDisposed:!0,result:null}];throw r;case 4:return[4,(e=l.otClient).fetchChanges.apply(e,(0,i._)(t))];case 5:return[2,{isDisposed:!1,result:n.sent()}]}})})()},N=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,r._)(function(){var e;return(0,a._)(this,function(r){switch(r.label){case 0:if(!l)throw Error("Expected watchedOtFile");return[4,O()];case 1:if(r.sent().isDisposed)throw Error("File was disposed");return[2,(e=l.otClient).transformSelection.apply(e,(0,i._)(t))]}})})()},A=function(e){if(!l)throw Error("Expected watchedOtFile");l.otClient.updateCursors(e)};-1!==l.otClient.version&&setTimeout(function(){var e;if(!u){if(!l)throw Error("Expected watchedOtFile");u=!0,null==(e=o.onReady)||e.call(o,{initialContent:l.otClient.getLocalContent(),writeChange:D,updateSelections:A,fetchChanges:P,transformSelection:N,version:l.otClient.version})}}),t&&(null==(n=o.onChange)||n.call(o,{changes:t,changeSource:Q.ChangeSource.Container,version:l.otClient.version,latestContent:l.otClient.getLocalContent(),userId:0}));var M=function(e,r){var t,n;if(!l)throw Error("Expected watchedOtFile");if(!u){u=!0,null==(n=o.onReady)||n.call(o,{initialContent:l.otClient.getLocalContent(),writeChange:D,updateSelections:A,fetchChanges:P,transformSelection:N,version:l.otClient.version});return}null==(t=o.onChange)||t.call(o,{changes:e,changeSource:Q.ChangeSource.Container,version:l.otClient.version,latestContent:l.otClient.getLocalContent(),userId:r})};l.otClient.on("changes",M),f=function(){if(!l)throw Error("Expected watchedOtFile");l.otClient.removeListener("commitComplete",m),l.otClient.removeListener("fileDirty",g),l.otClient.removeListener("fileClean",E),l.otClient.removeListener("commitStart",C),l.otClient.removeListener("error",S),l.otClient.removeListener("fsError",x),l.otClient.removeListener("changes",M),l.otClient.removeListener("cursor",F),l.otClient.removeListener("removeCursor",w),l.otClient.removeListener("promptUserReconnect",T),l.otClient.removeListener("transparentReconnect",R),l.otClient.removeListener("fileSavedChanged",_)},K()},y=function(){for(;d.length>0;){var r;null==(r=d.pop())||r({isDisposed:!0})}if(!c&&I.has(e)){if(c=!0,u=!0,f(),!l)throw Error("Expected watchedOtFile");l.listeners=l.listeners.filter(function(e){return e.dispose!==y}),0===l.listeners.length&&(l.otClient.destroy(),I.delete(e))}};return l.listeners.push((0,n._)((0,t._)({},o),{dispose:y,reregister:v})),v(null),y},watchFile:function(e,r){if(!(0,E.isAbsolutePath)(e)&&(0,E.isRoot)((0,E.toRelativeFsPath)(e)))throw Error("Cannot watch root directory");var o=!1,i=function(){o=!0;var r=N.get(e);r&&(r.listeners=r.listeners.filter(function(e){return e.dispose!==i}),0===r.listeners.length&&N.delete(e))};return et.readFile(e).then(function(a){if(!o){if(a.error){var s=Error(a.error);s.code=a.error,r.onError&&r.onError(s),i();return}var l=N.get(e);if(!l&&(l={path:e,type:Q.FileType.File,listeners:[],latestContent:a.content},N.set(e,l),x&&x.send({subscribeFile:{files:[{path:e.toString()}]}})),!l)throw Error("Expected watched file");l.listeners.push((0,n._)((0,t._)({},r),{dispose:i})),r.onChange(a.content)}}),i},listFiles:function(){return(0,r._)(function(){var e;return(0,a._)(this,function(t){switch(t.label){case 0:if(O&&u.performance.now()-R<1e4)return[2,O];return D||(D=(0,r._)(function(){var e,r,t,n,o;return(0,a._)(this,function(a){switch(a.label){case 0:return[4,(e=u).execImmediately.apply(e,["rg","--hidden","--files"].concat((0,i._)(w.ignoredDirs.flatMap(function(e){return["--glob","!".concat(e)]}))))];case 1:if(t=(r=a.sent()).output,n=r.error,o=function(e){return!(!e||(0,w.isHiddenFile)(e))},!n&&t)return[2,O={error:null,files:t.split("\n").filter(o)}];if("exit status 1"===n)return[2,O={error:null,files:[]}];return s.captureException(Error("Find file command failed with error: ".concat(n))),[2,{error:n,files:null}]}})})(),R=u.performance.now()),[4,D];case 1:return e=t.sent(),D=null,[2,e]}})})()},flush:function(e){return(0,r._)(function(e){var t,n,o,i,s,l,c,u,f,d,h,p,v,y,m,g,E,C,F,w,_,b,T,S,k,x,D,O,R,P,N,A,U,j,V,B,q,z,W,H,J,K,Y,Z,X,G=arguments;return(0,a._)(this,function(ee){switch(ee.label){case 0:if(t=G.length>1&&void 0!==G[1]?G[1]:Q.FlushSource.UNKNOWN,n=function(e){return(0,r._)(function(){var r,n,o,i,s,l,c,u;return(0,a._)(this,function(a){switch(a.label){case 0:if(r=e.path,!(n=M.get(r)))return[2];o=!0,i=!1,s=void 0,a.label=1;case 1:a.trys.push([1,6,7,8]),l=n[Symbol.iterator](),a.label=2;case 2:if(o=(c=l.next()).done)return[3,5];return[4,(0,c.value)(e.otClient.getLocalContent(),t)];case 3:a.sent(),a.label=4;case 4:return o=!0,[3,2];case 5:return[3,8];case 6:return u=a.sent(),i=!0,s=u,[3,8];case 7:try{o||null==l.return||l.return()}finally{if(i)throw s}return[7];case 8:return[2]}})})()},o=function(e){var r=e.path,n=!0,o=!1,i=void 0;try{for(var a,s=L[Symbol.iterator]();!(n=(a=s.next()).done);n=!0)(0,a.value)(r,t)}catch(e){o=!0,i=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw i}}},i=[],s=function(e){null===e.otClient.channel||e.otClient.isReconnecting||i.push(e.otClient.flush())},void 0!==e)return[3,9];l=!0,c=!1,u=void 0,ee.label=1;case 1:ee.trys.push([1,6,7,8]),f=I.values()[Symbol.iterator](),ee.label=2;case 2:if(l=(d=f.next()).done)return[3,5];return h=d.value,[4,n(h)];case 3:ee.sent(),ee.label=4;case 4:return l=!0,[3,2];case 5:return[3,8];case 6:return p=ee.sent(),c=!0,u=p,[3,8];case 7:try{l||null==f.return||f.return()}finally{if(c)throw u}return[7];case 8:v=!0,y=!1,m=void 0;try{for(g=I.values()[Symbol.iterator]();!(v=(E=g.next()).done);v=!0)C=E.value,s(C)}catch(e){y=!0,m=e}finally{try{v||null==g.return||g.return()}finally{if(y)throw m}}return[3,18];case 9:F=!0,w=!1,_=void 0,ee.label=10;case 10:ee.trys.push([10,15,16,17]),b=e[Symbol.iterator](),ee.label=11;case 11:if(F=(T=b.next()).done)return[3,14];if(S=T.value,void 0===(k=I.get(S)))return[3,13];return[4,n(k)];case 12:ee.sent(),ee.label=13;case 13:return F=!0,[3,11];case 14:return[3,17];case 15:return p=ee.sent(),w=!0,_=p,[3,17];case 16:try{F||null==b.return||b.return()}finally{if(w)throw _}return[7];case 17:x=!0,D=!1,O=void 0;try{for(R=e[Symbol.iterator]();!(x=(P=R.next()).done);x=!0)N=P.value,A=I.get(N),void 0!==A&&s(A)}catch(e){D=!0,O=e}finally{try{x||null==R.return||R.return()}finally{if(D)throw O}}ee.label=18;case 18:return ee.trys.push([18,20,,21]),[4,Promise.all(i.concat($))];case 19:if(ee.sent(),void 0===e){U=!0,j=!1,V=void 0;try{for(B=I.values()[Symbol.iterator]();!(U=(q=B.next()).done);U=!0)z=q.value,o(z)}catch(e){j=!0,V=e}finally{try{U||null==B.return||B.return()}finally{if(j)throw V}}}else{W=!0,H=!1,J=void 0;try{for(K=e[Symbol.iterator]();!(W=(Y=K.next()).done);W=!0)Z=Y.value,X=I.get(Z),void 0!==X&&o(X)}catch(e){H=!0,J=e}finally{try{W||null==K.return||K.return()}finally{if(H)throw J}}}return[3,21];case 20:return ee.sent(),[3,21];case 21:return[2]}})}).apply(this,arguments)},registerOnBeforeFlush:function(e,r){var t,n=null!=(t=M.get(e))?t:new Set;return n.add(r),M.set(e,n),function(){var t;return null==(t=M.get(e))?void 0:t.delete(r)}},registerOnFlushSuccess:function(e){return L.add(e),function(){L.delete(e)}},persist:function(e){var r=V();return e&&e.skipDebounce&&V.flush(),r},getOTVersion:function(e){if("SYNTHETIC_FILE_PATH.sql"===e)return 123;var r=I.get(e);if(!r)throw Error("No file with path ".concat(e," found."));return r.otClient.version},isFileOrDirSaved:function(e){if((0,C.isOTFile)(e)){var r=I.get(e);return!r||r.otClient.isFileSaved()}return!0},onDiskQuotaExceeded:function(e){return A.push(e),function(){A=A.filter(function(r){return r!==e})}}};return et}var $=c.Type.Object({cluster:c.Type.String(),sourceRepl:c.Type.String(),zipperToken:c.Type.String(),expirySeconds:c.Type.Number()});function Y(e){return(0,r._)(function(e){var r,t,n,o,i,s,l,c,f,h,p,v,y;return(0,a._)(this,function(a){switch(a.label){case 0:return r=e.replId,[4,(0,e.getCaptcha)()];case 1:return n=(t=a.sent()).isEmbed,o=t.hCaptchaSiteKey,i=t.recaptchaToken,s={captcha:t.captcha,isEmbed:n,hCaptchaSiteKey:o,recaptchaToken:i,asViewer:!0},[4,fetch("/data/repls/".concat(r,"/get_zipper_token"),{credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},method:"post",body:JSON.stringify(s)})];case 2:if(!(l=a.sent()).ok)throw Error("Failed to get zipper token: ".concat(l.status," ").concat(l.statusText));return[4,l.json()];case 3:if(c=a.sent(),!u.Value.Check($,c))throw(0,J.validationErrors)($,c);return f=c.cluster,h=c.sourceRepl,p=c.zipperToken,v=c.expirySeconds,y=(0,d.addSeconds)(new Date,v-10),[2,{sourceReplId:h,baseUrl:(0,F.getZipperUrl)(f),token:p,exp:y}]}})}).apply(this,arguments)}function Z(e){var n,o=e.replId,i=e.getCaptcha;function s(){return(0,r._)(function(){var e;return(0,a._)(this,function(r){switch(r.label){case 0:if(e=!n)return[3,2];return[4,n];case 1:e=r.sent().exp.getTime()<=new Date().getTime(),r.label=2;case 2:return e&&(n=Y({replId:o,getCaptcha:i})),[4,n];case 3:return[2,r.sent()]}})})()}var l={watchDir:function(e,r){return l.readDir(e).then(function(e){if(e.error){var t=Error(e.error);t.code=e.error,r.onError&&r.onError(t);return}return r.onChange(e.children)}),function(){}},watchFile:function(e,r){return l.readFile(e).then(function(e){if(e.error){var t=Error(e.error);t.code=e.error,r.onError&&r.onError(t);return}return r.onChange(e.content)}),function(){}},stat:function(e){return(0,r._)(function(){var r;return(0,a._)(this,function(t){switch(t.label){case 0:return[4,l.readFile(e)];case 1:if((r=t.sent()).error)switch(r.error){case Q.FsErrors.NotFound:return[2,{exists:!1}];case Q.FsErrors.IsDirectory:return[2,{exists:!0,type:Q.FileType.Directory,lastModified:new Date}]}return[2,{exists:!0,type:Q.FileType.File,byteLength:r.content.length,lastModified:new Date}]}})})()},readDir:function(e){return(0,r._)(function(){var r,n,o,i,l,c,u;return(0,a._)(this,function(a){switch(a.label){case 0:return[4,s()];case 1:return n=(r=a.sent()).sourceReplId,o=r.baseUrl,i=r.token,[4,fetch("".concat(o,"/repls/").concat(n,"/files/dir?path=").concat(e),(0,t._)({},i&&{headers:{Authorization:"Bearer ".concat(i)}}))];case 2:if(!(l=a.sent()).ok)return[3,4];return[4,l.json()];case 3:return[2,{children:null!=(c=a.sent())?c:[],error:null}];case 4:return[4,l.text()];case 5:if(u=a.sent(),404===l.status&&"file not found"===u)return[2,{error:Q.FsErrors.NotFound}];if(400===l.status&&"file is not a directory"===u)return[2,{error:Q.FsErrors.NotDirectory}];throw Error("Error when trying to read dir through zipper, status: ".concat(l.status,", body: ").concat(u));case 6:return[2]}})})()},readFile:function(e,n){return(0,r._)(function(){var r,n,o,i,l,c,u,f;return(0,a._)(this,function(a){switch(a.label){case 0:return[4,s()];case 1:return n=(r=a.sent()).sourceReplId,o=r.baseUrl,i=r.token,[4,fetch("".concat(o,"/repls/").concat(n,"/files/file?path=").concat(encodeURIComponent(e)),(0,t._)({},i&&{headers:{Authorization:"Bearer ".concat(i)}}))];case 2:if(!(l=a.sent()).ok)return[3,4];return c={},u=g.default.bind,[4,l.arrayBuffer()];case 3:return[2,(c.content=new(u.apply(g.default,[void 0,a.sent()])),c.error=null,c)];case 4:return[4,l.text()];case 5:if(f=a.sent(),404===l.status&&"file not found"===f)return[2,{error:Q.FsErrors.NotFound}];if(400===l.status&&"file is a directory"===f)return[2,{error:Q.FsErrors.IsDirectory}];throw Error("Error when trying to read file through zipper, status: ".concat(l.status,", body: ").concat(f));case 6:return[2]}})})()}};return l}e.s(["createZipperFsService",()=>Z,"default",()=>K,"getZipperToken",()=>Y],629712)}]);

//# debugId=10d52b76-ddf8-6cec-ffaf-e42364059a07
//# sourceMappingURL=67278e33d570cd1e.js.map